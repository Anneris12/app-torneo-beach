<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuadro Principal</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }

    header {
      background: #333;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 22px;
    }

    .filters {
      background: white;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #ccc;
      justify-content: center;
    }

    .match-card {
      background: white;
      margin: 10px;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    .match-header {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .team-line {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .winner {
      color: green;
      font-weight: bold;
    }
  </style>
</head>

<body>
<header>Cuadro Principal</header>

<div class="filters">
  <select id="filterRama">
    <option value="F">Femenino</option>
    <option value="M">Masculino</option>
  </select>

  <select id="filterRound">
    <option value="all">Todas las fases</option>
  </select>

  <select id="filterStatus">
    <option value="all">Todos los estados</option>
    <option value="pending">Pendientes</option>
    <option value="in_progress">En juego</option>
    <option value="finished">Finalizados</option>
  </select>

  <input id="filterTeam" placeholder="Buscar equipo..." style="padding:5px;" />
</div>

<div id="matchesContainer"></div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const matchesContainer = document.getElementById("matchesContainer");
  const filterRama  = document.getElementById("filterRama");
  const filterRound = document.getElementById("filterRound");
  const filterStatus= document.getElementById("filterStatus");
  const filterTeam  = document.getElementById("filterTeam");

  filterRama.addEventListener("change", loadMatches);
  filterRound.addEventListener("change", renderFilteredMatches);
  filterStatus.addEventListener("change", renderFilteredMatches);
  filterTeam.addEventListener("input", renderFilteredMatches);

  let allMatches = [];
  let availableRounds = new Set();

  async function loadMatches() {
    matchesContainer.innerHTML = "<p>Cargando...</p>";
    allMatches = [];
    availableRounds.clear();

    const rama = filterRama.value;

    const q = query(
      collection(db, "matches"),
      where("phase", "==", "maindraw"),
      where("rama", "==", rama)
    );

    const snap = await getDocs(q);
    snap.forEach(d => {
      let m = d.data();
      allMatches.push(m);
      availableRounds.add(m.roundLabel);
    });

    loadRoundFilter();
    renderFilteredMatches();
  }

  function loadRoundFilter() {
    filterRound.innerHTML = `<option value="all">Todas las fases</option>`;
    [...availableRounds].sort().forEach(r => {
      filterRound.innerHTML += `<option value="${r}">${r}</option>`;
    });
  }

  function renderFilteredMatches() {
    let rama = filterRama.value;
    let round = filterRound.value;
    let status = filterStatus.value;
    let team = filterTeam.value.toLowerCase();

    let list = allMatches.filter(m => {

      if (round !== "all" && m.roundLabel !== round) return false;
      if (status !== "all" && m.status !== status) return false;

      if (team.length > 0) {
        const t1 = (m.team1Name || "").toLowerCase();
        const t2 = (m.team2Name || "").toLowerCase();
        if (!t1.includes(team) && !t2.includes(team)) return false;
      }

      return true;
    });

    // ordenar por número de partido
    list.sort((a, b) => a.drawMatchNumber - b.drawMatchNumber);

    matchesContainer.innerHTML = "";

    list.forEach(m => {
      const card = document.createElement("div");
      card.className = "match-card";

      card.innerHTML = `
        <div class="match-header">#${m.drawMatchNumber} — ${m.roundLabel}</div>

        <div class="team-line ${m.winnerTeamId === m.team1Id ? "winner" : ""}">
          <span>${m.team1Name || "---"}</span>
          <span>${m.team1Score ?? ""}</span>
        </div>
        <div class="team-line ${m.winnerTeamId === m.team2Id ? "winner" : ""}">
          <span>${m.team2Name || "---"}</span>
          <span>${m.team2Score ?? ""}</span>
        </div>

        ${m.status === "finished" ? `<div><b>Ganador: ${m.winnerTeamName}</b></div>` : ""}
      `;

      matchesContainer.appendChild(card);
    });
  }

  loadMatches();
</script>

</body>
</html>
