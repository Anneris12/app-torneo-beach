<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Partido ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      background: #031926;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      text-transform: uppercase;
    }

    .top-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      gap: 8px;
    }

    .top-btn {
      background: #ffe36a;
      color: #000;
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 12px;
      text-decoration: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .card {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.25);
      margin-bottom: 22px;
      backdrop-filter: blur(14px);
    }

    label {
      font-size: 14px;
      opacity: 0.9;
      display: block;
      margin-bottom: 6px;
    }

    select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      background: rgba(0,0,0,0.28);
      color: white;
    }

    .state-btn-top {
      width: 100%;
      padding: 16px 0;
      border-radius: 12px;
      margin: 18px 0;
      border: none;
      font-size: 18px;
      font-weight: bold;
      background: #ffe36a;
      color:black;
      cursor: pointer;
    }

    .state-btn-top[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .estado-label {
      font-size: 14px;
      opacity: 0.85;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .config-panel {
      margin-top: 10px;
      margin-bottom: 4px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
    }

    .first-serve-panel {
      margin-top: 10px;
      margin-bottom: 4px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
    }

    .first-serve-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 4px 0;
      font-size: 13px;
      flex-wrap: wrap;
    }

    .first-serve-team-label {
      min-width: 70px;
      font-weight: 600;
    }

    .starter-label {
      font-size: 12px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .starter-label input {
      transform: scale(0.9);
    }

    .small-edit-btn {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 12px;
    }

    .sets-info {
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .sets-current {
      font-size: 14px;
      font-weight: 600;
      opacity: 0.9;
    }

    .sets-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .set-chip {
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.4);
      font-size: 13px;
    }

    .set-chip span.winner {
      color: #7cffc1;
      font-weight: 700;
    }

    .team-block {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 20px;
      background: rgba(0,0,0,0.35);
      border-radius: 16px;
      gap: 16px;
    }

    .team-info {
      flex: 1 1 auto;
    }

    .players {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .player-line {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .player-name {
      font-size: 22px;
      font-weight: 600;
    }

    .serve-icon {
      width: 28px;
      font-size: 26px;
      text-align: center;
    }

    .score {
      font-size: 40px;
      font-weight: bold;
      width: 60px;
      text-align: center;
    }

    .btns {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .big-btn {
      padding: 12px 0;
      font-size: 22px;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      background: #ffe36a;
      color: black;
    }

    .minus { background: #ff6b6b; }

    .set-btn {
      width: 100%;
      padding: 16px 0;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      background: #6be0ff;
      border: none;
      color: black;
      margin-top: 16px;
      cursor: pointer;
    }

    .undo-btn {
      background: #b3b3b3;
      color: #000;
    }
  </style>
</head>

<body>

  <h1>Panel del Partido</h1>

  <!-- CARTEL CAMBIO DE LADO (GRANDE + ANIMADO) -->
  <div id="sideChangeBanner"
       style="
        display:none;
        position:fixed;
        top:15px; left:50%;
        transform:translate(-50%, -20px);
        background:#ffe36a;
        color:#000;
        padding:18px 28px;
        border-radius:16px;
        font-weight:900;
        font-size:22px;
        letter-spacing:1px;
        box-shadow:0 6px 18px rgba(0,0,0,0.35);
        z-index:9999;
        opacity:0;
        transition:opacity .35s ease, transform .35s ease;
       ">
    üîÑ CAMBIO DE LADO
  </div>

  <!-- BOTONES SUPERIORES -->
  <div class="top-buttons">
    <a class="top-btn" href="admin.html">‚Üê Volver</a>
    <a class="top-btn" href="index.html">üè† Home</a>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <label>Rama</label>
<select id="filterCat">
  <option value="F" selected>Femenino</option>
  <option value="M">Masculino</option>
</select>

    <!-- Fase (grupos / cuadro) -->
    <label style="margin-top:10px;">Fase</label>
    <select id="filterPhase">
      <option value="groups">Fase de grupos</option>
      <option value="maindraw">Cuadro principal</option>
    </select>

    <!-- Zona (solo grupos) -->
    <label id="zoneLabel" style="margin-top:10px;">Zona</label>
    <select id="filterZone">
      <option value="all">Todas</option>
      <option value="A">Zona A</option>
      <option value="B">Zona B</option>
      <option value="C">Zona C</option>
      <option value="D">Zona D</option>
      <option value="E">Zona E</option>
      <option value="F">Zona F</option>
      <option value="G">Zona G</option>
      <option value="H">Zona H</option>
    </select>

    <!-- Ronda (solo cuadro) -->
    <label id="roundLabel" style="margin-top:10px; display:none;">Ronda</label>
    <select id="filterRound" style="display:none;">
      <option value="all">Todas</option>
    </select>

    <label style="margin-top:10px;">Cancha</label>
    <select id="filterCourt">
      <option value="all">Todas</option>
    </select>

    <label style="margin-top:16px;">Partido</label>
    <select id="selectMatch"></select>
  </div>

  <!-- PANEL DE PARTIDO -->
  <div id="matchPanel" style="display:none;">
    <div class="card">

      <!-- INFO DEL PARTIDO -->
      <div class="estado-label" id="matchNumberLabel">
        Partido: ‚Äî
      </div>
      <div class="estado-label" id="infoExtraLabel">
        Cancha: ‚Äî ¬∑ Hora: ‚Äî
      </div>
      <div class="estado-label" id="estadoLabel">
        Estado: ‚Äî
      </div>

      <!-- FORMATO DEL PARTIDO -->
      <div class="config-panel">
        <div class="estado-label" style="margin-bottom:6px;">
          Formato del partido
        </div>
        <div class="first-serve-row">
          <label class="starter-label">
            <input type="radio" name="setsMode" value="ONE" checked> 1 set
          </label>
          <label class="starter-label">
            <input type="radio" name="setsMode" value="BEST_OF_3"> Mejor de 3
          </label>
        </div>
      </div>

      <!-- INFO DE SETS -->
      <div class="sets-info">
        <div class="sets-current" id="setsCurrentLabel">
          Set actual: ‚Äî / ‚Äî 
        </div>
        <div class="sets-chips" id="setsChips"></div>
      </div>

      <!-- PANEL 1ER SAQUE -->
      <div class="first-serve-panel">
        <div class="estado-label" style="margin-bottom:6px;">
          Configurar 1er saque
        </div>
        <div class="first-serve-row">
          <span class="first-serve-team-label">Local:</span>
          <label class="starter-label">
            <input type="radio" name="localStarter" value="1" checked>
            <span id="localStarterName1">Jugador 1</span>
          </label>
          <label class="starter-label">
            <input type="radio" name="localStarter" value="2">
            <span id="localStarterName2">Jugador 2</span>
          </label>
        </div>
        <div class="first-serve-row">
          <span class="first-serve-team-label">Visitante:</span>
          <label class="starter-label">
            <input type="radio" name="visitStarter" value="1" checked>
            <span id="visitStarterName1">Jugador 1</span>
          </label>
          <label class="starter-label">
            <input type="radio" name="visitStarter" value="2">
            <span id="visitStarterName2">Jugador 2</span>
          </label>
        </div>
        <button type="button" id="btnEditFirstServe" class="top-btn small-edit-btn">
          Editar 1er saque
        </button>
      </div>

      <!-- PANEL CAMISETAS -->
      <div class="first-serve-panel">
        <div class="estado-label" style="margin-bottom:6px;">
          Configurar camisetas
        </div>
        <div class="first-serve-row">
          <span class="first-serve-team-label">Local #1:</span>
          <label class="starter-label">
            <input type="radio" name="localJerseyFirst" value="1" checked>
            <span id="localJerseyName1">Jugador 1</span>
          </label>
          <label class="starter-label">
            <input type="radio" name="localJerseyFirst" value="2">
            <span id="localJerseyName2">Jugador 2</span>
          </label>
        </div>
        <div class="first-serve-row">
          <span class="first-serve-team-label">Visitante #1:</span>
          <label class="starter-label">
            <input type="radio" name="visitJerseyFirst" value="1" checked>
            <span id="visitJerseyName1">Jugador 1</span>
          </label>
          <label class="starter-label">
            <input type="radio" name="visitJerseyFirst" value="2">
            <span id="visitJerseyName2">Jugador 2</span>
          </label>
        </div>
        <button type="button" id="btnSaveJerseys" class="top-btn small-edit-btn">
          Guardar camisetas
        </button>
      </div>

      <!-- MARCAR EN JUEGO ARRIBA -->
      <button
        class="state-btn-top"
        id="btnSetPlaying"
        onclick="setPlaying()"
      >
        üî• Marcar en juego
      </button>

      <!-- LOCAL -->
      <div class="team-block">
        <div class="team-info">
          <div class="players">
            <div class="player-line">
              <span id="localPlayer1ServeIcon" class="serve-icon"></span>
              <span id="localPlayer1Name" class="player-name">Jugador 1</span>
            </div>
            <div class="player-line">
              <span id="localPlayer2ServeIcon" class="serve-icon"></span>
              <span id="localPlayer2Name" class="player-name">Jugador 2</span>
            </div>
          </div>
        </div>
        <div class="score" id="localPoints">0</div>
        <div class="btns">
          <button class="big-btn" onclick="addPoint('local')">+1</button>
          <button class="big-btn minus" onclick="subPoint('local')">-1</button>
        </div>
      </div>

      <!-- VISITANTE -->
      <div class="team-block">
        <div class="team-info">
          <div class="players">
            <div class="player-line">
              <span id="visitPlayer1ServeIcon" class="serve-icon"></span>
              <span id="visitPlayer1Name" class="player-name">Jugador 1</span>
            </div>
            <div class="player-line">
              <span id="visitPlayer2ServeIcon" class="serve-icon"></span>
              <span id="visitPlayer2Name" class="player-name">Jugador 2</span>
            </div>
          </div>
        </div>
        <div class="score" id="visitPoints">0</div>
        <div class="btns">
          <button class="big-btn" onclick="addPoint('visit')">+1</button>
          <button class="big-btn minus" onclick="subPoint('visit')">-1</button>
        </div>
      </div>

      <button class="set-btn undo-btn" onclick="undoLast()">Deshacer √∫ltimo</button>
      <!-- Sin bot√≥n de finalizar partido: se finaliza solo por sets -->

    </div>
  </div>


<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    getDocs,
    doc,
    updateDoc,
    onSnapshot,
    deleteField,
    where,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const MATCHES_COLLECTION = "matches";
  
  // ==========================
  // Progresi√≥n del cuadro principal (maindraw)
  // from = n√∫mero de partido de origen
  // winnerTo / loserTo = a qu√© partido y en qu√© slot van
  // ==========================
  const MAIN_DRAW_PROGRESSIONS = [
    // ==========================
    // MASCULINO
    // ==========================

    // 1RA RONDA (1‚Äì16)
    { rama: "M", from: 1,  winnerTo: { match: 17, slot: 1 }, loserTo: { match: 25, slot: 1 } },
    { rama: "M", from: 2,  winnerTo: { match: 17, slot: 2 }, loserTo: { match: 25, slot: 2 } },

    { rama: "M", from: 3,  winnerTo: { match: 18, slot: 1 }, loserTo: { match: 26, slot: 1 } },
    { rama: "M", from: 4,  winnerTo: { match: 18, slot: 2 }, loserTo: { match: 26, slot: 2 } },

    { rama: "M", from: 5,  winnerTo: { match: 19, slot: 1 }, loserTo: { match: 27, slot: 1 } },
    { rama: "M", from: 6,  winnerTo: { match: 19, slot: 2 }, loserTo: { match: 27, slot: 2 } },

    { rama: "M", from: 7,  winnerTo: { match: 20, slot: 1 }, loserTo: { match: 28, slot: 1 } },
    { rama: "M", from: 8,  winnerTo: { match: 20, slot: 2 }, loserTo: { match: 28, slot: 2 } },

    { rama: "M", from: 9,  winnerTo: { match: 21, slot: 1 }, loserTo: { match: 29, slot: 1 } },
    { rama: "M", from: 10, winnerTo: { match: 21, slot: 2 }, loserTo: { match: 29, slot: 2 } },

    { rama: "M", from: 11, winnerTo: { match: 22, slot: 1 }, loserTo: { match: 30, slot: 1 } },
    { rama: "M", from: 12, winnerTo: { match: 22, slot: 2 }, loserTo: { match: 30, slot: 2 } },

    { rama: "M", from: 13, winnerTo: { match: 23, slot: 1 }, loserTo: { match: 31, slot: 1 } },
    { rama: "M", from: 14, winnerTo: { match: 23, slot: 2 }, loserTo: { match: 31, slot: 2 } },

    { rama: "M", from: 15, winnerTo: { match: 24, slot: 1 }, loserTo: { match: 32, slot: 1 } },
    { rama: "M", from: 16, winnerTo: { match: 24, slot: 2 }, loserTo: { match: 32, slot: 2 } },

    // 2DA RONDA PRINCIPAL (17‚Äì24)
    { rama: "M", from: 17, winnerTo: { match: 45, slot: 1 }, loserTo: { match: 40, slot: 2 } },
    { rama: "M", from: 18, winnerTo: { match: 45, slot: 2 }, loserTo: { match: 39, slot: 2 } },

    { rama: "M", from: 19, winnerTo: { match: 46, slot: 1 }, loserTo: { match: 38, slot: 2 } },
    { rama: "M", from: 20, winnerTo: { match: 46, slot: 2 }, loserTo: { match: 37, slot: 2 } },

    { rama: "M", from: 21, winnerTo: { match: 47, slot: 1 }, loserTo: { match: 36, slot: 2 } },
    { rama: "M", from: 22, winnerTo: { match: 47, slot: 2 }, loserTo: { match: 35, slot: 2 } },

    { rama: "M", from: 23, winnerTo: { match: 48, slot: 1 }, loserTo: { match: 34, slot: 2 } },
    { rama: "M", from: 24, winnerTo: { match: 48, slot: 2 }, loserTo: { match: 33, slot: 2 } },

    // 1RA RONDA PERDEDORES (25‚Äì32)
    { rama: "M", from: 25, winnerTo: { match: 33, slot: 1 }, loserTo: null },
    { rama: "M", from: 26, winnerTo: { match: 34, slot: 1 }, loserTo: null },
    { rama: "M", from: 27, winnerTo: { match: 35, slot: 1 }, loserTo: null },
    { rama: "M", from: 28, winnerTo: { match: 36, slot: 1 }, loserTo: null },
    { rama: "M", from: 29, winnerTo: { match: 37, slot: 1 }, loserTo: null },
    { rama: "M", from: 30, winnerTo: { match: 38, slot: 1 }, loserTo: null },
    { rama: "M", from: 31, winnerTo: { match: 39, slot: 1 }, loserTo: null },
    { rama: "M", from: 32, winnerTo: { match: 40, slot: 1 }, loserTo: null },

    // 2DA RONDA PERDEDORES (33‚Äì40)
    { rama: "M", from: 33, winnerTo: { match: 41, slot: 1 }, loserTo: null },
    { rama: "M", from: 34, winnerTo: { match: 41, slot: 2 }, loserTo: null },
    { rama: "M", from: 35, winnerTo: { match: 42, slot: 1 }, loserTo: null },
    { rama: "M", from: 36, winnerTo: { match: 42, slot: 2 }, loserTo: null },
    { rama: "M", from: 37, winnerTo: { match: 43, slot: 1 }, loserTo: null },
    { rama: "M", from: 38, winnerTo: { match: 43, slot: 2 }, loserTo: null },
    { rama: "M", from: 39, winnerTo: { match: 44, slot: 1 }, loserTo: null },
    { rama: "M", from: 40, winnerTo: { match: 44, slot: 2 }, loserTo: null },

    // 3RA RONDA PERDEDORES (41‚Äì44)
    { rama: "M", from: 41, winnerTo: { match: 49, slot: 1 }, loserTo: null },
    { rama: "M", from: 42, winnerTo: { match: 50, slot: 1 }, loserTo: null },
    { rama: "M", from: 43, winnerTo: { match: 51, slot: 1 }, loserTo: null },
    { rama: "M", from: 44, winnerTo: { match: 52, slot: 1 }, loserTo: null },

    // 3RA RONDA PRINCIPAL (45‚Äì48)
    { rama: "M", from: 45, winnerTo: { match: 53, slot: 1 }, loserTo: { match: 50, slot: 2 } },
    { rama: "M", from: 46, winnerTo: { match: 53, slot: 2 }, loserTo: { match: 49, slot: 2 } },
    { rama: "M", from: 47, winnerTo: { match: 54, slot: 1 }, loserTo: { match: 52, slot: 2 } },
    { rama: "M", from: 48, winnerTo: { match: 54, slot: 2 }, loserTo: { match: 51, slot: 2 } },

    // 4TA RONDA PERDEDORES (49‚Äì52)
    { rama: "M", from: 49, winnerTo: { match: 55, slot: 1 }, loserTo: null },
    { rama: "M", from: 50, winnerTo: { match: 55, slot: 2 }, loserTo: null },
    { rama: "M", from: 51, winnerTo: { match: 56, slot: 1 }, loserTo: null },
    { rama: "M", from: 52, winnerTo: { match: 56, slot: 2 }, loserTo: null },

    // PASE A SEMI (53‚Äì56)
    { rama: "M", from: 53, winnerTo: { match: 59, slot: 1 }, loserTo: { match: 58, slot: 2 } },
    { rama: "M", from: 54, winnerTo: { match: 60, slot: 1 }, loserTo: { match: 57, slot: 2 } },
    { rama: "M", from: 55, winnerTo: { match: 57, slot: 1 }, loserTo: null },
    { rama: "M", from: 56, winnerTo: { match: 58, slot: 1 }, loserTo: null },

    // PASE A SEMI (lado perdedores, 57‚Äì58)
    { rama: "M", from: 57, winnerTo: { match: 59, slot: 2 }, loserTo: null },
    { rama: "M", from: 58, winnerTo: { match: 60, slot: 2 }, loserTo: null },

    // SEMIS / 3ER PUESTO / FINAL
    { rama: "M", from: 59, winnerTo: { match: 62, slot: 1 }, loserTo: { match: 61, slot: 1 } },
    { rama: "M", from: 60, winnerTo: { match: 62, slot: 2 }, loserTo: { match: 61, slot: 2 } },

    // TODO: agregar filas "F" para rama femenina
	 // 1RA RONDA (1‚Äì8)
  { rama: "F", from: 1,  winnerTo: { match: 9,  slot: 1 }, loserTo: { match: 16, slot: 2 } },
  { rama: "F", from: 2,  winnerTo: { match: 9,  slot: 2 }, loserTo: { match: 16, slot: 1 } },

  { rama: "F", from: 3,  winnerTo: { match: 10, slot: 1 }, loserTo: { match: 15, slot: 2 } },
  { rama: "F", from: 4,  winnerTo: { match: 10, slot: 2 }, loserTo: { match: 15, slot: 1 } },

  { rama: "F", from: 5,  winnerTo: { match: 11, slot: 1 }, loserTo: { match: 14, slot: 2 } },
  { rama: "F", from: 6,  winnerTo: { match: 11, slot: 2 }, loserTo: { match: 14, slot: 1 } },

  { rama: "F", from: 7,  winnerTo: { match: 12, slot: 1 }, loserTo: { match: 13, slot: 2 } },
  { rama: "F", from: 8,  winnerTo: { match: 12, slot: 2 }, loserTo: { match: 13, slot: 1 } },

  // 2DA RONDA PRINCIPAL (9‚Äì12)
  { rama: "F", from: 9,  winnerTo: { match: 21, slot: 1 }, loserTo: { match: 18, slot: 2 } },
  { rama: "F", from: 10, winnerTo: { match: 21, slot: 2 }, loserTo: { match: 17, slot: 2 } },

  { rama: "F", from: 11, winnerTo: { match: 22, slot: 1 }, loserTo: { match: 20, slot: 2 } },
  { rama: "F", from: 12, winnerTo: { match: 22, slot: 2 }, loserTo: { match: 19, slot: 2 } },

  // 1RA RONDA PERDEDORES (13‚Äì16)
  { rama: "F", from: 13, winnerTo: { match: 17, slot: 1 }, loserTo: null },
  { rama: "F", from: 14, winnerTo: { match: 18, slot: 1 }, loserTo: null },
  { rama: "F", from: 15, winnerTo: { match: 19, slot: 1 }, loserTo: null },
  { rama: "F", from: 16, winnerTo: { match: 20, slot: 1 }, loserTo: null },

  // 2DA RONDA PERDEDORES (17‚Äì20)
  { rama: "F", from: 17, winnerTo: { match: 23, slot: 1 }, loserTo: null },
  { rama: "F", from: 18, winnerTo: { match: 23, slot: 2 }, loserTo: null },

  { rama: "F", from: 19, winnerTo: { match: 24, slot: 1 }, loserTo: null },
  { rama: "F", from: 20, winnerTo: { match: 24, slot: 2 }, loserTo: null },

  // PASE A SEMI PRINCIPAL (21‚Äì22)
  { rama: "F", from: 21, winnerTo: { match: 27, slot: 1 }, loserTo: { match: 26, slot: 2 } },
  { rama: "F", from: 22, winnerTo: { match: 28, slot: 1 }, loserTo: { match: 25, slot: 2 } },

  // 3RA RONDA PERDEDORES (23‚Äì24)
  { rama: "F", from: 23, winnerTo: { match: 25, slot: 1 }, loserTo: null },
  { rama: "F", from: 24, winnerTo: { match: 26, slot: 1 }, loserTo: null },

  // PASE A SEMI DESDE PERDEDORES (25‚Äì26)
  { rama: "F", from: 25, winnerTo: { match: 27, slot: 2 }, loserTo: null },
  { rama: "F", from: 26, winnerTo: { match: 28, slot: 2 }, loserTo: null },

  // SEMIFINALES (27‚Äì28)
  { rama: "F", from: 27, winnerTo: { match: 30, slot: 1 }, loserTo: { match: 29, slot: 1 } },
  { rama: "F", from: 28, winnerTo: { match: 30, slot: 2 }, loserTo: { match: 29, slot: 2 } },

  // 3ER PUESTO (29) ‚Äì terminal
  { rama: "F", from: 29, winnerTo: null, loserTo: null },

  // FINAL (30) ‚Äì terminal
  { rama: "F", from: 30, winnerTo: null, loserTo: null },
  ];

  let allMatches = [];
  let currentMatchId = null;
  let currentMatchData = null;
  let unsubscribeMatch = null;
  let stateHistory = [];
  let isEditingFirstServe = false;

  const selCat   = document.getElementById("filterCat");
  const selPhase = document.getElementById("filterPhase");
  const selZone  = document.getElementById("filterZone");
  const selRound = document.getElementById("filterRound");
  const selCourt = document.getElementById("filterCourt");
  const selMatch = document.getElementById("selectMatch");
  const panel    = document.getElementById("matchPanel");

  const zoneLabel  = document.getElementById("zoneLabel");
  const roundLabel = document.getElementById("roundLabel");

  const btnSetPlaying     = document.getElementById("btnSetPlaying");
  const estadoLabel       = document.getElementById("estadoLabel");
  const matchNumberLabel  = document.getElementById("matchNumberLabel");
  const infoExtraLabel    = document.getElementById("infoExtraLabel");
  const btnEditFirstServe = document.getElementById("btnEditFirstServe");
  const btnSaveJerseys    = document.getElementById("btnSaveJerseys");
  const setsCurrentLabel  = document.getElementById("setsCurrentLabel");
  const setsChips         = document.getElementById("setsChips");

  // Proteger acceso
  onAuthStateChanged(auth, u => { 
    if (!u) location.href = "login.html"; 
  });

  /* ------- Helpers de normalizaci√≥n ------- */

  function normalizeCategoria(c){
    if(!c) return "";
    const up = c.toString().toUpperCase();
    if(up.startsWith("F")) return "F";
    if(up.startsWith("M")) return "M";
    return up;
  }

  function normalizeHora(horaRaw) {
    if (!horaRaw && horaRaw !== 0) return "";
    let str = String(horaRaw).trim();
    if (!str) return "";

    if (/^\d{1,2}:\d{2}$/.test(str)) {
      const [h, m] = str.split(":");
      return h.padStart(2, "0") + ":" + m;
    }

    const digits = str.replace(/\D/g, "");
    if (digits.length === 3) {
      const h = digits.slice(0, 1);
      const m = digits.slice(1);
      return h.padStart(2, "0") + ":" + m.padEnd(2, "0");
    }
    if (digits.length === 4) {
      const h = digits.slice(0, 2);
      const m = digits.slice(2);
      return h + ":" + m;
    }

    return str;
  }

  function splitPlayers(teamName) {
    if (!teamName) return ["Jugador 1", "Jugador 2"];
    const parts = teamName.split("-");
    if (parts.length < 2) return [teamName.trim(), "Jugador 2"];
    return [parts[0].trim(), parts[1].trim()];
  }

  function normalizeZone(z) {
    if (!z) return "";
    const str = z.toString().trim().toUpperCase();
    return str.replace(/^ZONA\s+/, "");
  }

  function normalizeCancha(value) {
    if (value === null || value === undefined) return "";
    const str = value.toString().trim();
    return str;
  }

  function getCourtSortValue(court) {
    const raw = normalizeCancha(court);
    const num = Number(raw);
    if (!Number.isNaN(num)) return num;
    return Number.MAX_SAFE_INTEGER;
  }

  function getRadioValue(name) {
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    for (const r of radios) {
      if (r.checked) return Number(r.value);
    }
    return null;
  }

  function setRadioValue(name, value) {
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    radios.forEach(r => {
      r.checked = Number(r.value) === Number(value);
    });
  }

  function getSetsModeFromInputs() {
    const r = document.querySelector('input[name="setsMode"]:checked');
    return r ? r.value : "ONE";
  }

  function setSetsModeInputs(mode) {
    const value = mode || "ONE";
    const radios = document.querySelectorAll('input[name="setsMode"]');
    radios.forEach(r => {
      r.checked = (r.value === value);
    });
  }

  function setSetsModeDisabled(disabled) {
    const radios = document.querySelectorAll('input[name="setsMode"]');
    radios.forEach(r => {
      r.disabled = disabled;
    });
  }

  function setFirstServeInputsDisabled(disabled) {
    const inputs = document.querySelectorAll('input[name="localStarter"], input[name="visitStarter"]');
    inputs.forEach(i => {
      i.disabled = disabled;
    });
  }

  function setJerseyInputsDisabled(disabled) {
    const inputs = document.querySelectorAll('input[name="localJerseyFirst"], input[name="visitJerseyFirst"]');
    inputs.forEach(i => {
      i.disabled = disabled;
    });
    btnSaveJerseys.disabled = disabled;
  }

  function formatPlayerName(name, jerseyNumber) {
    const base = name || "Jugador";
    return `${base} (#${jerseyNumber})`;
  }

  function renderServeIcons() {
    const localP1Icon = document.getElementById("localPlayer1ServeIcon");
    const localP2Icon = document.getElementById("localPlayer2ServeIcon");
    const visitP1Icon = document.getElementById("visitPlayer1ServeIcon");
    const visitP2Icon = document.getElementById("visitPlayer2ServeIcon");

    localP1Icon.textContent = "";
    localP2Icon.textContent = "";
    visitP1Icon.textContent = "";
    visitP2Icon.textContent = "";

    const team = currentMatchData?.currentServerTeam;
    const player = currentMatchData?.currentServerPlayer;

    if (!team || !player) return;

    if (team === "local") {
      if (player === 1) localP1Icon.textContent = "üèê";
      if (player === 2) localP2Icon.textContent = "üèê";
    } else if (team === "visit") {
      if (player === 1) visitP1Icon.textContent = "üèê";
      if (player === 2) visitP2Icon.textContent = "üèê";
    }
  }

  function saveLastState() {
    if (currentMatchData) {
      stateHistory.push({ ...currentMatchData });
    }
  }

  // Sonido + cartel de cambio de lado
  function playSideChangeSound() {
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;

      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = "sine";
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start();
      osc.stop(ctx.currentTime + 0.18);
    } catch (e) {
      // si falla no pasa nada
    }
  }

  function showSideChangeBanner() {
    const banner = document.getElementById("sideChangeBanner");

    playSideChangeSound();

    banner.style.display = "block";

    requestAnimationFrame(() => {
      banner.style.opacity = 1;
      banner.style.transform = "translate(-50%, 0px)";
    });

    setTimeout(() => {
      banner.style.opacity = 0;
      banner.style.transform = "translate(-50%, -20px)";
      setTimeout(() => {
        banner.style.display = "none";
      }, 350);
    }, 2300);
  }

  function maybeShowSideChangeAlert(newLocalPoints, newVisitPoints) {
    if (!currentMatchData) return;

    const total = (newLocalPoints || 0) + (newVisitPoints || 0);
    if (total <= 0) return;

    const setsData = currentMatchData.setsData || [];
    const setActual = currentMatchData.setActual || (setsData.length + 1);

    const modulo = (setActual === 3 ? 5 : 7);

    if (total % modulo === 0) {
      showSideChangeBanner();
    }
  }

  // Decide ganador y perdedor seg√∫n setsData
  function getWinnerLoserFromMatch(matchData) {
    const sets = Array.isArray(matchData.setsData) ? matchData.setsData : [];
    let setsLocal = 0;
    let setsVisit = 0;

    sets.forEach(s => {
      const pl = s.puntosLocal ?? 0;
      const pv = s.puntosVisitante ?? 0;
      if (pl > pv) setsLocal++;
      else if (pv > pl) setsVisit++;
    });

    if (setsLocal === setsVisit) return null;

    const team1Wins = setsLocal > setsVisit;

    return {
      winnerSide: team1Wins ? 1 : 2,
      loserSide:  team1Wins ? 2 : 1
    };
  }

  // Propaga el resultado de un partido del cuadro principal
  async function propagateMainDrawResult(matchData) {
    if (matchData.phase !== "maindraw") return;

    const matchNumber = matchData.numeroPartido || matchData.drawMatchNumber;
    if (!matchNumber) return;

    const rama = (matchData.rama || matchData.categoria || matchData.category || "")
      .toString()
      .toUpperCase()
      .charAt(0); // "F" o "M"

    const progression = MAIN_DRAW_PROGRESSIONS.find(
      p => p.from === matchNumber && p.rama === rama
    );
    if (!progression) {
      console.warn("No hay progresi√≥n para partido", matchNumber, "rama", rama);
      return;
    }

    const wl = getWinnerLoserFromMatch(matchData);
    if (!wl) {
      console.warn("No se pudo determinar ganador/perdedor para el partido", matchNumber);
      return;
    }

    const winnerName = wl.winnerSide === 1
      ? (matchData.team1Name || matchData.localName || "")
      : (matchData.team2Name || matchData.visitanteName || "");

    const loserName  = wl.loserSide === 1
      ? (matchData.team1Name || matchData.localName || "")
      : (matchData.team2Name || matchData.visitanteName || "");

    const batch = writeBatch(db);

    async function setTeamInMatch(dest, isWinner) {
      if (!dest || !dest.match) return;

      const q = query(
        collection(db, MATCHES_COLLECTION),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama),
        where("numeroPartido", "==", dest.match)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        console.warn("No se encontr√≥ partido destino", dest.match, "rama", rama);
        return;
      }

      const ref = snap.docs[0].ref;
      const isSlot1 = dest.slot === 1;

      const updateData = {};
      if (isSlot1) {
        updateData.team1Name = isWinner ? winnerName : loserName;
      } else {
        updateData.team2Name = isWinner ? winnerName : loserName;
      }

      batch.update(ref, updateData);
    }

    // ganador
    await setTeamInMatch(progression.winnerTo, true);
    // perdedor (si existe)
    if (progression.loserTo) {
      await setTeamInMatch(progression.loserTo, false);
    }

    await batch.commit();
  }

  async function propagateSilverPlayInResult(matchData) {
    if (matchData.phase !== "silver") return;

    const round = (matchData.round || "").toString().toLowerCase();
    if (round !== "playin") return;

    const rama = (matchData.rama || matchData.categoria || matchData.category || "")
      .toString()
      .toUpperCase()
      .charAt(0);

    const wl = getWinnerLoserFromMatch(matchData);
    if (!wl) {
      console.warn("No se pudo determinar ganador del play-in de plata.");
      return;
    }

    const winnerName = wl.winnerSide === 1
      ? (matchData.team1Name || matchData.localName || "")
      : (matchData.team2Name || matchData.visitanteName || "");

    const winnerId = wl.winnerSide === 1
      ? (matchData.team1Id ?? null)
      : (matchData.team2Id ?? null);

    const targetQuery = query(
      collection(db, MATCHES_COLLECTION),
      where("phase", "==", "silver"),
      where("rama", "==", rama),
      where("sourceTeam2.matchId", "==", matchData.id)
    );

    const snap = await getDocs(targetQuery);
    if (snap.empty) {
      console.warn("No se encontraron partidos de plata para completar con play-in.");
      return;
    }

    const batch = writeBatch(db);

    snap.forEach(docSnap => {
      batch.update(docSnap.ref, {
        team2Name: winnerName || null,
        team2Id: winnerId,
        status: "pending"
      });
    });

    await batch.commit();
  }

  // Cerrar set autom√°tico seg√∫n puntuaci√≥n
  async function maybeAutoCloseSet(newLocal, newVisit) {
    if (!currentMatchId || !currentMatchData) return;
    if (currentMatchData.estado !== "En juego") return;

    const setsData = currentMatchData.setsData || [];
    const setsMode = currentMatchData.setsMode || getSetsModeFromInputs();
    const setActual = currentMatchData.setActual || (setsData.length + 1);

    let targetPoints;
    if (setsMode === "BEST_OF_3" && setActual === 3) {
      targetPoints = 15;
    } else {
      targetPoints = 21;
    }

    const maxPoints = Math.max(newLocal, newVisit);
    const diff = Math.abs(newLocal - newVisit);

    if (maxPoints < targetPoints || diff < 2) return;

    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);

    const winner = newLocal > newVisit ? "local" : "visit";

    const prevSetsData = currentMatchData.setsData || [];
    const setNumber = setActual;

    const newSetEntry = {
      setNumber,
      puntosLocal: newLocal,
      puntosVisitante: newVisit
    };

    let setsLocal = currentMatchData.setsLocal || 0;
    let setsVisitante = currentMatchData.setsVisitante || 0;

    if (winner === "local") setsLocal++;
    else setsVisitante++;

    const totalPointsLocalPrev = currentMatchData.totalPointsLocal || 0;
    const totalPointsVisitantePrev = currentMatchData.totalPointsVisitante || 0;

    const totalPointsLocal = totalPointsLocalPrev + newLocal;
    const totalPointsVisitante = totalPointsVisitantePrev + newVisit;

    let estado = currentMatchData.estado || "Pendiente";

    if (setsMode === "ONE") {
      estado = "Finalizado";
    } else {
      if (setsLocal === 2 || setsVisitante === 2) {
        estado = "Finalizado";
      } else {
        estado = "En juego";
      }
    }

    const newSetActual = setNumber + 1;

    await updateDoc(matchRef, {
      setsData: [...prevSetsData, newSetEntry],
      setsLocal,
      setsVisitante,
      totalPointsLocal,
      totalPointsVisitante,
      setActual: newSetActual,
      puntosLocal: 0,
      puntosVisitante: 0,
      currentServerTeam: null,
      currentServerPlayer: null,
      localNextServer: null,
      visitNextServer: null,
      estado,
      setsMode
    });

    const finalSetsData = [...prevSetsData, newSetEntry];

    if (estado === "Finalizado") {
      try {
        const finalData = {
          ...currentMatchData,
          setsData: finalSetsData,
          setsLocal,
          setsVisitante,
          totalPointsLocal,
          totalPointsVisitante,
          setActual: newSetActual,
          puntosLocal: 0,
          puntosVisitante: 0,
          estado,
          setsMode
        };
        await propagateMainDrawResult(finalData);
        await propagateSilverPlayInResult(finalData);
      } catch (e) {
        console.error("Error propagando resultado de cierre:", e);
      }
    }
  }

  // ----------- Cargar TODOS los partidos de matches -----------  
  async function loadMatches() {
    const qAll = query(collection(db, MATCHES_COLLECTION), orderBy("numeroPartido"));
    const snap = await getDocs(qAll);

    allMatches = [];

    snap.forEach(docSnap => {
      const d = docSnap.data();

      const categoria = normalizeCategoria(d.categoria || d.category || d.rama || "");
      const phase     = (d.phase || "").toString().trim().toLowerCase();
      const roundLabelVal = (d.roundLabel || "").toString();

      let estado = d.estado;
      if (!estado && d.status) {
        if (d.status === "finished") estado = "Finalizado";
        else if (d.status === "in_progress") estado = "En juego";
        else estado = "Pendiente";
      }
      if (!estado) estado = "Pendiente";

      allMatches.push({
        id: docSnap.id,
        numeroPartido: d.numeroPartido ?? d.drawMatchNumber ?? null,
        drawMatchNumber: d.drawMatchNumber ?? null,
        localName: d.localName ?? d.team1Name ?? "",
        visitanteName: d.visitanteName ?? d.team2Name ?? "",
        team1Id: d.team1Id ?? null,
        team2Id: d.team2Id ?? null,
        categoria,
        phase,          
        roundLabel: roundLabelVal,
        round: d.round ?? null,
        zona: normalizeZone(d.zona),
        cancha: normalizeCancha(d.cancha),
        fecha: d.fecha || "",
        hora: d.hora || "",
        estado,
        setsData: d.setsData || [],
        setsLocal: d.setsLocal ?? 0,
        setsVisitante: d.setsVisitante ?? 0,
        totalPointsLocal: d.totalPointsLocal ?? 0,
        totalPointsVisitante: d.totalPointsVisitante ?? 0,
        setActual: d.setActual ?? 1,
        puntosLocal: d.puntosLocal ?? 0,
        puntosVisitante: d.puntosVisitante ?? 0,
        currentServerTeam: d.currentServerTeam ?? null,
        currentServerPlayer: d.currentServerPlayer ?? null,
        localNextServer: d.localNextServer ?? null,
        visitNextServer: d.visitNextServer ?? null,
        localFirstServer: d.localFirstServer ?? null,
        visitFirstServer: d.visitFirstServer ?? null
      });
    });

    buildRoundOptions();
    buildZoneOptions();
    buildCourtOptions();
    updatePhaseUI();
  }

  function isMainDraw(m) {
    return m.phase === "maindraw";
  }

  function buildRoundOptions() {
    selRound.innerHTML = `<option value="all">Todas</option>`;

    const roundsSet = new Set();

    allMatches
      .filter(isMainDraw)
      .forEach(m => {
        const r = m.roundLabel || "";
        if (r) roundsSet.add(r);
      });

    Array.from(roundsSet).sort().forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      selRound.appendChild(opt);
    });
  }

  function buildZoneOptions() {
    const prev = selZone.value;
    selZone.innerHTML = `<option value="all">Todas</option>`;

    const zonesSet = new Set();

    allMatches
      .filter(m => !isMainDraw(m))
      .forEach(m => {
        const z = normalizeZone(m.zona);
        if (z) zonesSet.add(z);
      });

    Array.from(zonesSet).sort().forEach(z => {
      const opt = document.createElement("option");
      opt.value = z;
      opt.textContent = `Zona ${z}`;
      selZone.appendChild(opt);
    });

    if (prev && zonesSet.has(prev)) {
      selZone.value = prev;
    }
  }

  function buildCourtOptions() {
    const prev = selCourt.value;
    selCourt.innerHTML = `<option value="all">Todas</option>`;

    const courtsSet = new Set();

    allMatches.forEach(m => {
      const court = normalizeCancha(m.cancha);
      if (court) courtsSet.add(court);
    });

    Array.from(courtsSet)
      .sort((a, b) => getCourtSortValue(a) - getCourtSortValue(b))
      .forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = `Cancha ${c}`;
        selCourt.appendChild(opt);
      });

    if (prev && courtsSet.has(prev)) {
      selCourt.value = prev;
    }
  }

  function updatePhaseUI() {
    const phase = selPhase.value; // groups | maindraw

    selMatch.value = "";
    currentMatchId = null;
    panel.style.display = "none";

    if (phase === "groups") {
      zoneLabel.style.display  = "";
      selZone.style.display    = "";
      roundLabel.style.display = "none";
      selRound.style.display   = "none";
    } else {
      zoneLabel.style.display  = "none";
      selZone.style.display    = "none";
      roundLabel.style.display = "";
      selRound.style.display   = "";
    }

    renderMatchList();
  }

  function renderMatchList() {
    selMatch.innerHTML = `<option value="">-- Eleg√≠ un partido --</option>`;

    const phaseFilter = selPhase.value;
    let list = [...allMatches];

    list = list.filter(m => {
      const md = isMainDraw(m);
      if (phaseFilter === "maindraw") return md;
      return !md;
    });

    // Rama (obligatorio: siempre F o M)
	list = list.filter(m => m.categoria === selCat.value);

    if (phaseFilter === "groups" && selZone.value !== "all") {
      list = list.filter(m => m.zona === selZone.value);
    }

    if (phaseFilter === "maindraw" && selRound.value !== "all") {
      list = list.filter(m => m.roundLabel === selRound.value);
    }

    if (selCourt.value !== "all") {
      list = list.filter(m => normalizeCancha(m.cancha) === selCourt.value);
    }

    list = list.filter(m => m.estado !== "Finalizado");

    list.sort((a, b) => {
      const na = typeof a.numeroPartido === "number" ? a.numeroPartido : 9999;
      const nb = typeof b.numeroPartido === "number" ? b.numeroPartido : 9999;
      const ca = getCourtSortValue(a.cancha);
      const cb = getCourtSortValue(b.cancha);
      if (ca !== cb) return ca - cb;
      return na - nb;
    });

    list.forEach(m => {
      const labelNumero = typeof m.numeroPartido === "number"
        ? `#${m.numeroPartido} ‚Äì `
        : "";
      const labelCancha = m.cancha ? `Cancha ${m.cancha} ¬∑ ` : "";

      selMatch.innerHTML += `
        <option value="${m.id}">
          ${labelCancha}${labelNumero}${m.localName} vs ${m.visitanteName}
        </option>
      `;
    });
  }

  selCat.onchange   = renderMatchList;
  selPhase.onchange = updatePhaseUI;
  selZone.onchange  = renderMatchList;
  selRound.onchange = renderMatchList;
  selCourt.onchange = renderMatchList;

  selMatch.onchange = () => {
    currentMatchId = selMatch.value;
    stateHistory = [];

    if (unsubscribeMatch) {
      unsubscribeMatch();
      unsubscribeMatch = null;
    }

    if (!currentMatchId) { 
      panel.style.display = "none"; 
      return; 
    }

    panel.style.display = "block";

    const ref = doc(db, MATCHES_COLLECTION, currentMatchId);
    unsubscribeMatch = onSnapshot(ref, snap => {
      currentMatchData = snap.data();
      renderPanel();
    });
  };

  function renderSetsInfo() {
    const setsData = currentMatchData.setsData || [];
    const setsMode = currentMatchData.setsMode || getSetsModeFromInputs();
    const setsMax = (setsMode === "BEST_OF_3") ? 3 : 1;
    const setActualStored = currentMatchData.setActual || (setsData.length + 1);
    const setActual = Math.min(setActualStored, setsMax);

    setsCurrentLabel.textContent = `Set actual: ${setActual} / ${setsMax}`;

    let html = "";
    setsData.forEach(s => {
      const pl = s.puntosLocal ?? 0;
      const pv = s.puntosVisitante ?? 0;
      const localWinner = pl > pv;
      const visitWinner = pv > pl;

      html += `
        <div class="set-chip">
          <span class="${localWinner ? "winner" : ""}">${pl}</span>
          -
          <span class="${visitWinner ? "winner" : ""}">${pv}</span>
        </div>
      `;
    });

    setsChips.innerHTML = html;
  }

  function renderPanel() {
    if (!currentMatchData) return;

    const localFullName  = currentMatchData.localName     || currentMatchData.team1Name     || "";
    const visitFullName  = currentMatchData.visitanteName || currentMatchData.team2Name     || "";

    document.getElementById("localPoints").textContent = currentMatchData.puntosLocal ?? 0;
    document.getElementById("visitPoints").textContent = currentMatchData.puntosVisitante ?? 0;

    const [localP1, localP2]   = splitPlayers(localFullName);
    const [visitP1, visitP2]   = splitPlayers(visitFullName);

    const localJerseyFirst = currentMatchData.localJerseyFirst || 1;
    const visitJerseyFirst = currentMatchData.visitJerseyFirst || 1;

    const localP1Jersey = localJerseyFirst === 1 ? 1 : 2;
    const localP2Jersey = localJerseyFirst === 1 ? 2 : 1;
    const visitP1Jersey = visitJerseyFirst === 1 ? 1 : 2;
    const visitP2Jersey = visitJerseyFirst === 1 ? 2 : 1;

    document.getElementById("localPlayer1Name").textContent  = formatPlayerName(localP1 || "Jugador 1", localP1Jersey);
    document.getElementById("localPlayer2Name").textContent  = formatPlayerName(localP2 || "Jugador 2", localP2Jersey);
    document.getElementById("visitPlayer1Name").textContent  = formatPlayerName(visitP1 || "Jugador 1", visitP1Jersey);
    document.getElementById("visitPlayer2Name").textContent  = formatPlayerName(visitP2 || "Jugador 2", visitP2Jersey);

    document.getElementById("localStarterName1").textContent = localP1 || "Jugador 1";
    document.getElementById("localStarterName2").textContent = localP2 || "Jugador 2";
    document.getElementById("visitStarterName1").textContent = visitP1 || "Jugador 1";
    document.getElementById("visitStarterName2").textContent = visitP2 || "Jugador 2";

    document.getElementById("localJerseyName1").textContent = localP1 || "Jugador 1";
    document.getElementById("localJerseyName2").textContent = localP2 || "Jugador 2";
    document.getElementById("visitJerseyName1").textContent = visitP1 || "Jugador 1";
    document.getElementById("visitJerseyName2").textContent = visitP2 || "Jugador 2";

    if (typeof currentMatchData.numeroPartido === "number") {
      matchNumberLabel.textContent = `Partido #${currentMatchData.numeroPartido}`;
    } else {
      matchNumberLabel.textContent = "Partido: ‚Äî";
    }

    const cancha = currentMatchData.cancha || "‚Äî";
    const rawHora = currentMatchData.hora || "";
    const horaFormateada = normalizeHora(rawHora);
    infoExtraLabel.textContent = `Cancha: ${cancha} ¬∑ Hora: ${horaFormateada || "‚Äî"}`;

    const estado = currentMatchData.estado || "Pendiente";
    estadoLabel.textContent = `Estado: ${estado}`;

    btnSetPlaying.disabled = false;
    btnSetPlaying.style.background = "#ffe36a";
    btnSetPlaying.style.color = "black";
    btnSetPlaying.textContent = "üî• Marcar en juego";

    if (estado === "En juego") {
      btnSetPlaying.disabled = true;
      btnSetPlaying.style.background = "#7cffc1";
      btnSetPlaying.style.color = "black";
      btnSetPlaying.textContent = "‚úÖ En juego";
    } else if (estado === "Finalizado") {
      btnSetPlaying.disabled = true;
      btnSetPlaying.style.background = "#7cffc1";
      btnSetPlaying.style.color = "black";
      btnSetPlaying.textContent = "üèÅ Partido finalizado";
    }

    const setsMode = currentMatchData.setsMode || getSetsModeFromInputs();
    setSetsModeInputs(setsMode);

    if (estado === "Pendiente") {
      setSetsModeDisabled(false);
    } else {
      setSetsModeDisabled(true);
    }

    const localFS = currentMatchData.localFirstServer || 1;
    const visitFS = currentMatchData.visitFirstServer || 1;
    setRadioValue("localStarter", localFS);
    setRadioValue("visitStarter", visitFS);
    setRadioValue("localJerseyFirst", localJerseyFirst);
    setRadioValue("visitJerseyFirst", visitJerseyFirst);

    if (estado === "En juego" || estado === "Finalizado") {
      if (!isEditingFirstServe) {
        setFirstServeInputsDisabled(true);
      }
      btnEditFirstServe.disabled = (estado === "Finalizado");
      btnEditFirstServe.textContent = isEditingFirstServe
        ? "Bloquear 1er saque"
        : "Editar 1er saque";
    } else {
      isEditingFirstServe = false;
      setFirstServeInputsDisabled(false);
      btnEditFirstServe.disabled = false;
      btnEditFirstServe.textContent = "Editar 1er saque";
    }

    setJerseyInputsDisabled(estado !== "Pendiente");

    renderServeIcons();
    renderSetsInfo();
  }

  btnEditFirstServe.addEventListener("click", () => {
    if (!currentMatchData) return;
    if (currentMatchData.estado !== "En juego") {
      alert("Solo pod√©s editar el 1er saque cuando el partido est√° en juego.");
      return;
    }
    isEditingFirstServe = !isEditingFirstServe;
    setFirstServeInputsDisabled(!isEditingFirstServe);
    btnEditFirstServe.textContent = isEditingFirstServe
      ? "Bloquear 1er saque"
      : "Editar 1er saque";
  });

  btnSaveJerseys.addEventListener("click", async () => {
    if (!currentMatchId || !currentMatchData) return;
    if (currentMatchData.estado !== "Pendiente") {
      alert("Solo pod√©s editar las camisetas antes de iniciar el partido.");
      return;
    }

    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);
    const localJerseyFirst = getRadioValue("localJerseyFirst") || 1;
    const visitJerseyFirst = getRadioValue("visitJerseyFirst") || 1;

    await updateDoc(matchRef, {
      localJerseyFirst,
      visitJerseyFirst
    });
  });

  async function updateServe(pointWinner) {
    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);

    let {
      currentServerTeam,
      currentServerPlayer,
      localNextServer,
      visitNextServer,
      localFirstServer,
      visitFirstServer
    } = currentMatchData || {};

    if (!localFirstServer) {
      localFirstServer = getRadioValue("localStarter") || 1;
    }
    if (!visitFirstServer) {
      visitFirstServer = getRadioValue("visitStarter") || 1;
    }

    if (!localNextServer) localNextServer = localFirstServer;
    if (!visitNextServer) visitNextServer = visitFirstServer;

    const updates = {
      localFirstServer,
      visitFirstServer,
      localNextServer,
      visitNextServer
    };

    if (!currentServerTeam) {
      if (pointWinner === "local") {
        currentServerTeam = "local";
        currentServerPlayer = localNextServer;
        localNextServer = localNextServer === 1 ? 2 : 1;
      } else {
        currentServerTeam = "visit";
        currentServerPlayer = visitNextServer;
        visitNextServer = visitNextServer === 1 ? 2 : 1;
      }
      updates.currentServerTeam = currentServerTeam;
      updates.currentServerPlayer = currentServerPlayer;
      updates.localNextServer = localNextServer;
      updates.visitNextServer = visitNextServer;
    } else if (pointWinner === currentServerTeam) {
      // mismo sacador
    } else {
      if (pointWinner === "local") {
        currentServerTeam = "local";
        currentServerPlayer = localNextServer;
        localNextServer = localNextServer === 1 ? 2 : 1;
        updates.currentServerTeam = currentServerTeam;
        updates.currentServerPlayer = currentServerPlayer;
        updates.localNextServer = localNextServer;
      } else {
        currentServerTeam = "visit";
        currentServerPlayer = visitNextServer;
        visitNextServer = visitNextServer === 1 ? 2 : 1;
        updates.currentServerTeam = currentServerTeam;
        updates.currentServerPlayer = currentServerPlayer;
        updates.visitNextServer = visitNextServer;
      }
    }

    await updateDoc(matchRef, updates);
  }

  window.addPoint = async side => {
    if (!currentMatchId || !currentMatchData) return;

    if (currentMatchData.estado === "Finalizado") {
      alert("El partido ya est√° finalizado, no pod√©s modificar el marcador.");
      return;
    }

    if (currentMatchData.estado !== "En juego") {
      alert("No pod√©s modificar el marcador hasta que el partido est√© EN JUEGO.");
      return;
    }

    saveLastState();

    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);

    const oldLocal = currentMatchData.puntosLocal || 0;
    const oldVisit = currentMatchData.puntosVisitante || 0;

    const newLocal = side === "local" ? oldLocal + 1 : oldLocal;
    const newVisit = side === "visit" ? oldVisit + 1 : oldVisit;

    maybeShowSideChangeAlert(newLocal, newVisit);

    await updateDoc(matchRef, {
      puntosLocal: newLocal,
      puntosVisitante: newVisit
    });

    await updateServe(side);

    await maybeAutoCloseSet(newLocal, newVisit);
  };

  window.subPoint = async side => {
    if (!currentMatchId || !currentMatchData) return;

    if (currentMatchData.estado === "Finalizado") {
      alert("El partido ya est√° finalizado, no pod√©s modificar el marcador.");
      return;
    }

    if (currentMatchData.estado !== "En juego") {
      alert("No pod√©s modificar el marcador hasta que el partido est√© EN JUEGO.");
      return;
    }

    saveLastState();

    const key = side === "local" ? "puntosLocal" : "puntosVisitante";
    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);

    await updateDoc(matchRef, {
      [key]: Math.max(0, (currentMatchData[key] || 0) - 1)
    });
  };

  window.setPlaying = async () => {
    if (!currentMatchId || !currentMatchData) return;

    const confirmar = confirm("¬øEst√°s segura de que quer√©s marcar este partido como EN JUEGO?");
    if (!confirmar) return;

    saveLastState();

    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);

    const localFirst = getRadioValue("localStarter") || 1;
    const visitFirst = getRadioValue("visitStarter") || 1;
    const localJerseyFirst = getRadioValue("localJerseyFirst") || 1;
    const visitJerseyFirst = getRadioValue("visitJerseyFirst") || 1;
    const setsMode = getSetsModeFromInputs();

    await updateDoc(matchRef, {
      estado: "En juego",
      localFirstServer: localFirst,
      visitFirstServer: visitFirst,
      localJerseyFirst,
      visitJerseyFirst,
      currentServerTeam: null,
      currentServerPlayer: null,
      localNextServer: localFirst,
      visitNextServer: visitFirst,
      setsMode,
      setActual: currentMatchData.setActual || 1
    });

    isEditingFirstServe = false;
  };

  window.undoLast = async () => {
    if (!currentMatchId || stateHistory.length === 0) return;

    const matchRef = doc(db, MATCHES_COLLECTION, currentMatchId);
    const prev = stateHistory.pop();
    if (!prev) return;

    const knownSetFields = [
      "setsData",
      "setsLocal",
      "setsVisitante",
      "totalPointsLocal",
      "totalPointsVisitante",
      "setActual",
      "puntosLocal",
      "puntosVisitante",
      "currentServerTeam",
      "currentServerPlayer",
      "localNextServer",
      "visitNextServer",
      "estado",
      "setsMode",
      "localFirstServer",
      "visitFirstServer",
      "localJerseyFirst",
      "visitJerseyFirst"
    ];

    const fieldsToUpdate = new Set([
      ...Object.keys(prev),
      ...knownSetFields
    ]);

    const updates = {};

    fieldsToUpdate.forEach((key) => {
      if (Object.prototype.hasOwnProperty.call(prev, key)) {
        const value = prev[key];
        updates[key] = value === undefined ? deleteField() : value;
      } else {
        updates[key] = deleteField();
      }
    });

    await updateDoc(matchRef, updates);
  };

  loadMatches();
</script>

</body>
</html>
