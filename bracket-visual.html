<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cuadro Principal - Visual</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f1f1f1;
    margin: 0;
    padding: 0;
    overflow-x: auto;
  }

  header {
    background: #333;
    color: #fff;
    text-align: center;
    padding: 12px;
  }

  .selector {
    background: white;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  /* CONTENEDOR PRINCIPAL DEL BRACKET */
  .bracket {
    display: flex;
    gap: 30px;
    padding: 20px;
    min-width: 1600px; /* para que no colapse en celular */
  }

  .round {
    display: flex;
    flex-direction: column;
    gap: 40px;
    min-width: 220px;
  }

  .round-title {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 18px;
  }

  .match-box {
    background: white;
    border-radius: 8px;
    padding: 8px;
    border: 1px solid #ccc;
    position: relative;
    width: 200px;
  }

  .team {
    padding: 5px 0;
    display: flex;
    justify-content: space-between;
  }

  .winner {
    font-weight: bold;
    color: green;
  }

  /* LINEAS QUE UNEN LLAVES */
  .connector {
    position: absolute;
    right: -30px;
    top: 50%;
    width: 30px;
    height: 2px;
    background: #444;
  }

  .vertical-line {
    position: absolute;
    height: 80px;
    width: 2px;
    background: #444;
    right: -30px;
  }
</style>

</head>

<body>

<header>Cuadro Principal - Vista con llaves</header>

<div class="selector">
  <select id="ramaSelector">
    <option value="F">Femenino</option>
    <option value="M">Masculino</option>
  </select>
</div>

<div id="bracketContainer" class="bracket"></div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const bracketContainer = document.getElementById("bracketContainer");
  const ramaSelector     = document.getElementById("ramaSelector");

  ramaSelector.addEventListener("change", loadBracket);
  window.addEventListener("DOMContentLoaded", loadBracket);

  async function loadBracket() {
    bracketContainer.innerHTML = "Cargando...";

    const rama = ramaSelector.value;

    const snap = await getDocs(
      query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      )
    );

    if (snap.empty) {
      bracketContainer.innerHTML = "<p>No hay cuadro generado aún.</p>";
      return;
    }

    const matches = snap.docs.map(d => d.data());

    // AGRUPAMOS POR RONDA
    const roundsOrder = [
      "1ra ronda",
      "2da ronda",
      "1er ronda perd.",
      "2da ronda perd.",
      "3ra ronda",
      "3ra ronda perd.",
      "4ta ronda perd.",
      "Pase a semi",
      "5ta ronda perd.",
      "Semi 1",
      "Semi 2",
      "3er puesto",
      "Final"
    ];

    const grouped = {};
    roundsOrder.forEach(r => grouped[r] = []);

    matches.forEach(m => grouped[m.roundLabel]?.push(m));

    // ORDENAR PARTIDOS DE CADA RONDA POR Nº
    Object.keys(grouped).forEach(r => {
      grouped[r].sort((a,b) => a.drawMatchNumber - b.drawMatchNumber);
    });

    // RENDER DE LAS COLUMNAS
    bracketContainer.innerHTML = "";

    Object.entries(grouped).forEach(([roundLabel, list]) => {
      if (list.length === 0) return;

      const col = document.createElement("div");
      col.className = "round";
      col.innerHTML += `<div class="round-title">${roundLabel}</div>`;

      list.forEach(m => {
        const box = document.createElement("div");
        box.className = "match-box";

        box.innerHTML = `
          <div class="team ${m.winnerTeamId === m.team1Id ? "winner" : ""}">
            <span>${m.team1Name || "---"}</span>
          </div>
          <div class="team ${m.winnerTeamId === m.team2Id ? "winner" : ""}">
            <span>${m.team2Name || "---"}</span>
          </div>
        `;

        col.appendChild(box);
      });

      bracketContainer.appendChild(col);
    });
  }
</script>

</body>
</html>
