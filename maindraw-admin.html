<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Cuadro principal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      background: #031926;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }

    /* Botones superiores */
    .top-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-btn {
      background: #ffe36a;
      color: #000;
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 12px;
      text-decoration: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    /* Título */
    h1 {
      text-align: center;
      margin-top: 0;
      text-transform: uppercase;
    }

    /* Panel central */
    .panel {
      max-width: 800px;
      margin: 0 auto;
      background: #052235;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .panel h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .panel p {
      font-size: 14px;
      color: #d0d0d0;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    .controls label {
      font-size: 14px;
      font-weight: 600;
    }

    .controls select {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 14px;
    }

    .controls button {
      border-radius: 10px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .btn-primary {
      background: #ffe36a;
      color: #000;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.08);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }

    #mainDrawStatus {
      margin-top: 10px;
      font-size: 14px;
      min-height: 24px;
      white-space: pre-line;
    }

    @media (max-width: 480px) {
      .panel {
        padding: 15px;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>

<div class="top-buttons">
  <a class="top-btn" href="admin.html">Volver</a>
  <a class="top-btn" href="bracket.html">Ver cuadro (tabla)</a>
  <a class="top-btn" href="bracket-visual.html">Ver cuadro (llaves)</a>
</div>

<h1>ADMIN CUADRO PRINCIPAL</h1>

<main>
  <div class="panel">
    <h2>Configurar cuadro principal (Main Draw)</h2>
    <p>
      Paso 1: Importar los partidos del cuadro (1 al 62) con número de partido, ronda, cruce, fecha, hora y cancha.<br>
      Paso 2: Asignar los equipos de la 1ra ronda según el ranking general.
    </p>

    <div class="controls">
      <label for="mainDrawRama">Rama:</label>
      <select id="mainDrawRama">
        <option value="F">Femenino</option>
        <option value="M">Masculino</option>
      </select>

      <button id="btnCheckMainDraw" type="button" class="btn-secondary">
        Ver estado del cuadro
      </button>

      <button id="btnImportMainDraw" type="button" class="btn-secondary">
        Importar partidos (CSV)
      </button>

      <button id="btnExportMainDraw" type="button" class="btn-secondary">
        Exportar partidos (CSV)
      </button>

      <button id="btnAssignFromRanking" type="button" class="btn-primary">
        Asignar equipos según ranking
      </button>
    </div>

    <p style="font-size:13px; color:#b0b0b0; margin-top:0;">
      Formato CSV esperado (1ra fila encabezados):<br>
      <code>numeroPartido;ronda;cruce;fecha;hora;cancha</code><br>
      Ej: <code>1;1ra ronda;1 vs 32;2026-02-01;08:00;1</code>
    </p>

    <div id="mainDrawStatus"></div>

    <!-- input de archivo oculto -->
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
  </div>
</main>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    writeBatch,
    doc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // proteger acceso
  onAuthStateChanged(auth, u => {
    if (!u) location.href = "login.html";
  });

  const mainDrawRamaSelect   = document.getElementById("mainDrawRama");
  const btnCheckMainDraw     = document.getElementById("btnCheckMainDraw");
  const btnImportMainDraw    = document.getElementById("btnImportMainDraw");
  const btnExportMainDraw    = document.getElementById("btnExportMainDraw");
  const btnAssignFromRanking = document.getElementById("btnAssignFromRanking");
  const mainDrawStatus       = document.getElementById("mainDrawStatus");
  const fileInput            = document.getElementById("fileInput");

  btnCheckMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    checkMainDrawStatus(rama);
  });

  btnImportMainDraw.addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const rama = mainDrawRamaSelect.value;
    await importMainDrawFromFile(file, rama);
    fileInput.value = "";
  });

  btnExportMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    exportMainDrawToCSV(rama);
  });

  btnAssignFromRanking.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    assignTeamsFromRanking(rama);
  });

  /* ============================
   * Helpers
   * ============================ */

  function normalizeHoraImport(h){
    if(!h) return "";
    let s = String(h).trim();

    // Si ya viene en formato H:MM / HH:MM lo dejamos
    if(/^\d{1,2}:\d{2}$/.test(s)) return s;

    // Sacamos todo lo que no sea dígito
    const dig = s.replace(/\D/g,"");

    if (dig.length === 3) {
      // 800 -> 8:00
      return dig[0] + ":" + dig.substring(1).padEnd(2,"0");
    }
    if (dig.length === 4) {
      // 0830 -> 08:30
      return dig.substring(0,2) + ":" + dig.substring(2);
    }

    // Si es raro, lo dejamos como vino
    return s;
  }

  /* ============================
   * 1) CONFIG ESTRUCTURAL DEL CUADRO
   * ============================ */

  const FIRST_ROUND_SEED_MAP = [
    { match: 1,  seed1: 1,  seed2: 32 },
    { match: 2,  seed1: 17, seed2: 16 },
    { match: 3,  seed1: 9,  seed2: 24 },
    { match: 4,  seed1: 25, seed2: 8 },
    { match: 5,  seed1: 5,  seed2: 28 },
    { match: 6,  seed1: 21, seed2: 12 },
    { match: 7,  seed1: 13, seed2: 20 },
    { match: 8,  seed1: 29, seed2: 4 },
    { match: 9,  seed1: 3,  seed2: 30 },
    { match: 10, seed1: 19, seed2: 14 },
    { match: 11, seed1: 11, seed2: 22 },
    { match: 12, seed1: 27, seed2: 6 },
    { match: 13, seed1: 7,  seed2: 26 },
    { match: 14, seed1: 23, seed2: 10 },
    { match: 15, seed1: 15, seed2: 18 },
    { match: 16, seed1: 31, seed2: 2 }
  ];

  const MAIN_DRAW_CONFIG_32 = {
    1:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    2:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    3:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    4:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    5:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    6:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    7:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    8:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    9:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    10: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    11: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    12: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    13: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    14: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    15: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    16: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },

    17: { roundLabel: "2da ronda",        slot1SourceFrom: 1,  slot1SourceResult: "winner", slot2SourceFrom: 2,  slot2SourceResult: "winner" },
    18: { roundLabel: "2da ronda",        slot1SourceFrom: 3,  slot1SourceResult: "winner", slot2SourceFrom: 4,  slot2SourceResult: "winner" },
    19: { roundLabel: "2da ronda",        slot1SourceFrom: 5,  slot1SourceResult: "winner", slot2SourceFrom: 6,  slot2SourceResult: "winner" },
    20: { roundLabel: "2da ronda",        slot1SourceFrom: 7,  slot1SourceResult: "winner", slot2SourceFrom: 8,  slot2SourceResult: "winner" },
    21: { roundLabel: "2da ronda",        slot1SourceFrom: 9,  slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "winner" },
    22: { roundLabel: "2da ronda",        slot1SourceFrom: 11, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "winner" },
    23: { roundLabel: "2da ronda",        slot1SourceFrom: 13, slot1SourceResult: "winner", slot2SourceFrom: 14, slot2SourceResult: "winner" },
    24: { roundLabel: "2da ronda",        slot1SourceFrom: 15, slot1SourceResult: "winner", slot2SourceFrom: 16, slot2SourceResult: "winner" },

    25: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 1,  slot1SourceResult: "loser",  slot2SourceFrom: 2,  slot2SourceResult: "loser" },
    26: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 3,  slot1SourceResult: "loser",  slot2SourceFrom: 4,  slot2SourceResult: "loser" },
    27: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 5,  slot1SourceResult: "loser",  slot2SourceFrom: 6,  slot2SourceResult: "loser" },
    28: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 7,  slot1SourceResult: "loser",  slot2SourceFrom: 8,  slot2SourceResult: "loser" },
    29: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 9,  slot1SourceResult: "loser",  slot2SourceFrom: 10, slot2SourceResult: "loser" },
    30: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 11, slot1SourceResult: "loser",  slot2SourceFrom: 12, slot2SourceResult: "loser" },
    31: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 13, slot1SourceResult: "loser",  slot2SourceFrom: 14, slot2SourceResult: "loser" },
    32: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 15, slot1SourceResult: "loser",  slot2SourceFrom: 16, slot2SourceResult: "loser" },

    33: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 25, slot1SourceResult: "winner", slot2SourceFrom: 23, slot2SourceResult: "loser" },
    34: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 26, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "loser" },
    35: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 27, slot1SourceResult: "winner", slot2SourceFrom: 21, slot2SourceResult: "loser" },
    36: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 28, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "loser" },
    37: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 29, slot1SourceResult: "winner", slot2SourceFrom: 17, slot2SourceResult: "loser" },
    38: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 30, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "loser" },
    39: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 31, slot1SourceResult: "winner", slot2SourceFrom: 19, slot2SourceResult: "loser" },
    40: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 32, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "loser" },

    41: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 33, slot1SourceResult: "winner", slot2SourceFrom: 34, slot2SourceResult: "winner" },
    42: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 35, slot1SourceResult: "winner", slot2SourceFrom: 36, slot2SourceResult: "winner" },
    43: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 37, slot1SourceResult: "winner", slot2SourceFrom: 38, slot2SourceResult: "winner" },
    44: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 39, slot1SourceResult: "winner", slot2SourceFrom: 40, slot2SourceResult: "winner" },

    45: { roundLabel: "3ra ronda",        slot1SourceFrom: 17, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "winner" },
    46: { roundLabel: "3ra ronda",        slot1SourceFrom: 19, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "winner" },
    47: { roundLabel: "3ra ronda",        slot1SourceFrom: 21, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "winner" },
    48: { roundLabel: "3ra ronda",        slot1SourceFrom: 23, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "winner" },

    49: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 41, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "loser" },
    50: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 42, slot1SourceResult: "winner", slot2SourceFrom: 45, slot2SourceResult: "loser" },
    51: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 43, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "loser" },
    52: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 44, slot1SourceResult: "winner", slot2SourceFrom: 47, slot2SourceResult: "loser" },

    53: { roundLabel: "Pase a semi",      slot1SourceFrom: 45, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "winner" },
    54: { roundLabel: "Pase a semi",      slot1SourceFrom: 47, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "winner" },

    55: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 49, slot1SourceResult: "winner", slot2SourceFrom: 50, slot2SourceResult: "winner" },
    56: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 51, slot1SourceResult: "winner", slot2SourceFrom: 52, slot2SourceResult: "winner" },

    57: { roundLabel: "Pase a semi",      slot1SourceFrom: 55, slot1SourceResult: "winner", slot2SourceFrom: 54, slot2SourceResult: "loser" },
    58: { roundLabel: "Pase a semi",      slot1SourceFrom: 56, slot1SourceResult: "winner", slot2SourceFrom: 53, slot2SourceResult: "loser" },

    59: { roundLabel: "Semi 1",           slot1SourceFrom: 53, slot1SourceResult: "winner", slot2SourceFrom: 57, slot2SourceResult: "winner" },
    60: { roundLabel: "Semi 2",           slot1SourceFrom: 54, slot1SourceResult: "winner", slot2SourceFrom: 58, slot2SourceResult: "winner" },

    61: { roundLabel: "3er puesto",       slot1SourceFrom: 59, slot1SourceResult: "loser",  slot2SourceFrom: 60, slot2SourceResult: "loser" },
    62: { roundLabel: "Final",            slot1SourceFrom: 59, slot1SourceResult: "winner", slot2SourceFrom: 60, slot2SourceResult: "winner" }
  };

  /* ============================
   * 2) ESTADO DEL CUADRO
   * ============================ */

  async function checkMainDrawStatus(rama) {
    mainDrawStatus.textContent = "Revisando cuadro...";

    const q = query(
      collection(db, "matches"),
      where("phase", "==", "maindraw"),
      where("rama", "==", rama)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      mainDrawStatus.textContent = `No hay partidos de cuadro cargados para ${rama === "F" ? "Femenino" : "Masculino"}.\nImportá el CSV primero.`;
    } else {
      mainDrawStatus.textContent = `Hay ${snap.size} partidos de cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.\nLuego podés asignar equipos de 1ra ronda según el ranking.`;
    }
  }

  /* ============================
   * 3) IMPORTAR PARTIDOS DESDE CSV
   * ============================ */

  async function importMainDrawFromFile(file, rama) {
    try {
      mainDrawStatus.textContent = "Leyendo archivo CSV...";
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) {
        mainDrawStatus.textContent = "El archivo no tiene datos (necesita encabezados y filas).";
        return;
      }

      const headerLine = lines[0];
      const sep = headerLine.includes(";") ? ";" : ",";
      const headersRaw = headerLine.split(sep).map(h => h.trim());
      const headers = headersRaw.map(h => h.toLowerCase());

      const idxNum = headers.findIndex(h =>
        [
          "numero",
          "numeropartido",
          "numero_partido",
          "numpartido",
          "#",
          "partido",
          "match",
          "drawmatchnumber"
        ].includes(h)
      );

      const idxRonda = headers.findIndex(h =>
        ["ronda", "round", "roundlabel"].includes(h)
      );

      const idxCruce = headers.findIndex(h => h.includes("cruce"));
      const idxFecha = headers.findIndex(h => h.startsWith("fecha"));
      const idxHora  = headers.findIndex(h => h.startsWith("hora"));
      const idxCancha= headers.findIndex(h => h.startsWith("cancha"));

      if (idxNum === -1 || idxCruce === -1 || idxFecha === -1 || idxHora === -1 || idxCancha === -1) {
        mainDrawStatus.textContent =
          "No se encontraron las columnas requeridas en el CSV.\n" +
          "Necesita al menos: numeroPartido, cruce, fecha, hora, cancha.";
        return;
      }

      // borrar partidos previos de esta rama
      mainDrawStatus.textContent = "Eliminando partidos anteriores del cuadro para esta rama...";
      const existingQ = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );
      const existingSnap = await getDocs(existingQ);

      if (!existingSnap.empty) {
        const batchDel = writeBatch(db);
        existingSnap.forEach(docSnap => {
          batchDel.delete(docSnap.ref);
        });
        await batchDel.commit();
      }

      // crear nuevos
      mainDrawStatus.textContent = "Creando partidos del cuadro a partir del CSV...";

      const matchesCol = collection(db, "matches");
      const batch = writeBatch(db);

      let totalRows = 0;

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const partsRaw = line.split(sep);
        const parts = partsRaw.map(x => (x ?? "").toString().trim());

        const numStr = parts[idxNum] || "";
        if (!numStr) continue;

        const matchNum = parseInt(numStr, 10);
        if (isNaN(matchNum)) continue;

        const cfg = MAIN_DRAW_CONFIG_32[matchNum];
        if (!cfg) continue;

        const cruceVal = parts[idxCruce] || "";
        const fechaVal = parts[idxFecha] || "";
        const horaVal  = parts[idxHora]  || "";
        const canchaVal= parts[idxCancha] || "";
        const rondaCSV = idxRonda >= 0 ? (parts[idxRonda] || "") : "";

        let cruceFinal = cruceVal;
        if (!cruceFinal) {
          const seedMap = FIRST_ROUND_SEED_MAP.find(m => m.match === matchNum);
          if (seedMap) {
            cruceFinal = `${seedMap.seed1} vs ${seedMap.seed2}`;
          }
        }

        const docRef = doc(matchesCol);
        const baseData = {
          phase: "maindraw",
          rama,
          drawMatchNumber: matchNum,
          numeroPartido: matchNum,
          roundLabel: cfg.roundLabel,
          status: "pending",
          team1Id: null,
          team1Name: null,
          team2Id: null,
          team2Name: null,
          cruce: cruceFinal || null,
          cancha: canchaVal || null,
          fecha: fechaVal || null,
          hora: normalizeHoraImport(horaVal) || null,
          slot1SourceFrom: cfg.slot1SourceFrom ?? null,
          slot1SourceResult: cfg.slot1SourceResult ?? null,
          slot2SourceFrom: cfg.slot2SourceFrom ?? null,
          slot2SourceResult: cfg.slot2SourceResult ?? null,
          setsData: []
        };

        if (rondaCSV) {
          baseData.roundLabelCSV = rondaCSV;
        }

        batch.set(docRef, baseData);
        totalRows++;
      }

      await batch.commit();

      mainDrawStatus.textContent =
        `✅ Importación completa. Se crearon ${totalRows} partidos de cuadro para ` +
        `${rama === "F" ? "Femenino" : "Masculino"}.\n` +
        "Ahora podés asignar los equipos de la 1ra ronda según el ranking.";

    } catch (err) {
      console.error(err);
      mainDrawStatus.textContent = "❌ Error al importar el cuadro. Revisá la consola para más detalles.";
    }
  }

  /* ============================
   * 4) EXPORTAR PARTIDOS A CSV
   * ============================ */

  async function exportMainDrawToCSV(rama) {
    try {
      mainDrawStatus.textContent = "Exportando partidos del cuadro…";

      const q = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        mainDrawStatus.textContent =
          `No hay partidos cargados del cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.`;
        return;
      }

      const rows = [
        ["numeroPartido", "ronda", "cruce", "fecha", "hora", "cancha"]
      ];

      const items = snap.docs
        .map(d => d.data())
        .sort((a, b) => (a.numeroPartido || 0) - (b.numeroPartido || 0));

      items.forEach(m => {
        rows.push([
          m.numeroPartido || "",
          m.roundLabel || "",
          m.cruce || "",
          m.fecha || "",
          m.hora || "",
          m.cancha || ""
        ]);
      });

      const csvContent = rows
        .map(r => r.map(v => String(v)).join(";"))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `maindraw_${rama}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      mainDrawStatus.textContent = "✔ Exportación lista.";

    } catch (error) {
      console.error(error);
      mainDrawStatus.textContent = "❌ Error exportando el cuadro.";
    }
  }

  /* ============================
   * 5) LEER RANKING GENERAL
   * ============================ */

  async function fetchRankingForRama(rama) {
    const q = query(
      collection(db, "rankingGeneral"),
      where("rama", "==", rama)
    );

    const snap = await getDocs(q);
    const items = snap.docs.map(d => d.data());

    items.sort((a, b) => (a.position || 9999) - (b.position || 9999));
    return items;
  }

  /* ============================
   * 6) ASIGNAR EQUIPOS EN 1RA RONDA
   * ============================ */

  async function assignTeamsFromRanking(rama) {
    try {
      mainDrawStatus.textContent = "Verificando que existan partidos de cuadro...";

      const q = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );
      const snap = await getDocs(q);

      if (snap.empty) {
        mainDrawStatus.textContent =
          `❌ No hay partidos de cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.\nPrimero importá el cuadro con el CSV.`;
        return;
      }

      const matchByNumber = {};
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const num = data.drawMatchNumber || data.numeroPartido;
        if (!num) return;
        matchByNumber[num] = docSnap.ref;
      });

      const missingFirstRound = FIRST_ROUND_SEED_MAP
        .filter(m => !matchByNumber[m.match])
        .map(m => m.match);

      if (missingFirstRound.length > 0) {
        mainDrawStatus.textContent =
          "❌ Faltan algunos partidos de 1ra ronda en el cuadro importado.\n" +
          "No se encontraron estos números de partido: " + missingFirstRound.join(", ");
        return;
      }

      mainDrawStatus.textContent = "Leyendo ranking general...";
      const ranking = await fetchRankingForRama(rama);
      if (!ranking || ranking.length < 32) {
        mainDrawStatus.textContent =
          `❌ El ranking de ${rama === "F" ? "Femenino" : "Masculino"} tiene menos de 32 equipos (encontrados: ${ranking.length || 0}).`;
        return;
      }

      const top32 = ranking.slice(0, 32);
      const seedByNumber = {};
      top32.forEach((item, idx) => {
        const seedNum = idx + 1;
        seedByNumber[seedNum] = {
          teamId: item.teamId || null,
          teamName: item.teamName || `Seed ${seedNum}`
        };
      });

      mainDrawStatus.textContent = "Asignando equipos de la 1ra ronda según el ranking...";

      const batch = writeBatch(db);

      FIRST_ROUND_SEED_MAP.forEach(map => {
        const ref = matchByNumber[map.match];
        if (!ref) return;

        const s1 = seedByNumber[map.seed1];
        const s2 = seedByNumber[map.seed2];

        const updateData = {};
        if (s1) {
          updateData.team1Id = s1.teamId;
          updateData.team1Name = s1.teamName;
        }
        if (s2) {
          updateData.team2Id = s2.teamId;
          updateData.team2Name = s2.teamName;
        }

        updateData.status = "pending";

        batch.update(ref, updateData);
      });

      await batch.commit();

      mainDrawStatus.textContent =
        `✅ Equipos asignados en los 16 partidos de 1ra ronda para ${rama === "F" ? "Femenino" : "Masculino"}.\n` +
        "El resto del cuadro se irá completando según se vayan cerrando los partidos.";

    } catch (err) {
      console.error(err);
      mainDrawStatus.textContent = "❌ Error al asignar equipos desde el ranking. Revisá la consola para más detalles.";
    }
  }
</script>

</body>
</html>
