<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Cuadro Principal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      background: #031926;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }

    /* Botones superiores (igual estilo que otras pantallas) */
    .top-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .top-btn {
      background: #ffe36a;
      color: #000;
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 12px;
      text-decoration: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    h1 {
      text-align: center;
      margin-top: 0;
      text-transform: uppercase;
      font-size: 20px;
      margin-bottom: 20px;
    }

    /* Panel central */
    .panel {
      background: #ffffff;
      color: #000;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.4);
      max-width: 700px;
      margin: 0 auto;
      padding: 16px 18px 18px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .panel p {
      margin: 6px 0 10px;
      font-size: 14px;
      color: #444;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 15px 0;
    }

    .controls label {
      font-weight: 600;
      font-size: 14px;
    }

    .controls select {
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .controls button {
      border-radius: 10px;
      padding: 7px 12px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
    }

    .btn-secondary {
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
    }

    #mainDrawStatus {
      margin-top: 10px;
      font-size: 14px;
      color: #111;
      min-height: 24px;
      white-space: pre-line;
    }

    @media (max-width: 480px) {
      .panel {
        padding: 12px 12px 14px;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a class="top-btn" href="admin.html">← Volver al panel admin</a>
  <a class="top-btn" href="index.html">Inicio</a>
</div>

<h1>CUADRO PRINCIPAL</h1>

<main>
  <div class="panel">
    <h2>Generar Main Draw desde ranking</h2>
    <p>
      Desde acá vas a generar el cuadro principal a partir de la tabla general:<br>
      <b>Masculino</b> toma los primeros <b>32</b> equipos y <b>Femenino</b> los primeros <b>16</b>.
    </p>

    <div class="controls">
      <label for="mainDrawRama">Rama:</label>
      <select id="mainDrawRama">
        <option value="F">Femenino</option>
        <option value="M">Masculino</option>
      </select>

      <button id="btnCheckMainDraw" type="button" class="btn-secondary">
        Ver estado del cuadro
      </button>

      <button id="btnGenerateMainDraw" type="button" class="btn-primary">
        Generar cuadro desde ranking
      </button>
    </div>

    <div id="mainDrawStatus"></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    writeBatch,
    doc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // -----------------------
  // Firebase config
  // -----------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const mainDrawRamaSelect   = document.getElementById("mainDrawRama");
  const btnCheckMainDraw     = document.getElementById("btnCheckMainDraw");
  const btnGenerateMainDraw  = document.getElementById("btnGenerateMainDraw");
  const mainDrawStatus       = document.getElementById("mainDrawStatus");

  btnCheckMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    checkMainDrawStatus(rama);
  });

  btnGenerateMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    generateMainDrawFromRanking(rama);
  });

  // ============================
  // 1) SEED MAPS
  // ============================

  // Masculino – 32 equipos
  const FIRST_ROUND_SEED_MAP = [
    { match: 1,  seed1: 1,  seed2: 32 },
    { match: 2,  seed1: 17, seed2: 16 },
    { match: 3,  seed1: 9,  seed2: 24 },
    { match: 4,  seed1: 25, seed2: 8  },
    { match: 5,  seed1: 5,  seed2: 28 },
    { match: 6,  seed1: 21, seed2: 12 },
    { match: 7,  seed1: 13, seed2: 20 },
    { match: 8,  seed1: 29, seed2: 4  },
    { match: 9,  seed1: 3,  seed2: 30 },
    { match: 10, seed1: 19, seed2: 14 },
    { match: 11, seed1: 11, seed2: 22 },
    { match: 12, seed1: 27, seed2: 6  },
    { match: 13, seed1: 7,  seed2: 26 },
    { match: 14, seed1: 23, seed2: 10 },
    { match: 15, seed1: 15, seed2: 18 },
    { match: 16, seed1: 31, seed2: 2  }
  ];

  // Femenino – 16 equipos, igual que el Excel
  const FIRST_ROUND_SEED_MAP_F = [
    { match: 1, seed1: 1,  seed2: 16 },
    { match: 2, seed1: 8,  seed2: 9  },
    { match: 3, seed1: 5,  seed2: 12 },
    { match: 4, seed1: 13, seed2: 4  },
    { match: 5, seed1: 3,  seed2: 14 },
    { match: 6, seed1: 11, seed2: 6  },
    { match: 7, seed1: 7,  seed2: 10 },
    { match: 8, seed1: 15, seed2: 2  }
  ];

  // ============================
  // 2) CONFIG MASCULINO – 32 EQUIPOS, 62 PARTIDOS
  // ============================

  const MAIN_DRAW_CONFIG_32 = {
    // 1ra RONDA
    1:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    2:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    3:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2Source: null },
    4:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    5:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    6:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    7:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    8:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    9:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    10: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    11: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    12: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    13: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    14: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    15: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    16: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },

    // 2da RONDA (ganadores)
    17: { roundLabel: "2da ronda",        slot1SourceFrom: 1,  slot1SourceResult: "winner", slot2SourceFrom: 2,  slot2SourceResult: "winner" },
    18: { roundLabel: "2da ronda",        slot1SourceFrom: 3,  slot1SourceResult: "winner", slot2SourceFrom: 4,  slot2SourceResult: "winner" },
    19: { roundLabel: "2da ronda",        slot1SourceFrom: 5,  slot1SourceResult: "winner", slot2SourceFrom: 6,  slot2SourceResult: "winner" },
    20: { roundLabel: "2da ronda",        slot1SourceFrom: 7,  slot1SourceResult: "winner", slot2SourceFrom: 8,  slot2SourceResult: "winner" },
    21: { roundLabel: "2da ronda",        slot1SourceFrom: 9,  slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "winner" },
    22: { roundLabel: "2da ronda",        slot1SourceFrom: 11, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "winner" },
    23: { roundLabel: "2da ronda",        slot1SourceFrom: 13, slot1SourceResult: "winner", slot2SourceFrom: 14, slot2SourceResult: "winner" },
    24: { roundLabel: "2da ronda",        slot1SourceFrom: 15, slot1SourceResult: "winner", slot2SourceFrom: 16, slot2SourceResult: "winner" },

    // 1er RONDA PERDEDORES
    25: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 1,  slot1SourceResult: "loser",  slot2SourceFrom: 2,  slot2SourceResult: "loser" },
    26: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 3,  slot1SourceResult: "loser",  slot2SourceFrom: 4,  slot2SourceResult: "loser" },
    27: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 5,  slot1SourceResult: "loser",  slot2SourceFrom: 6,  slot2SourceResult: "loser" },
    28: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 7,  slot1SourceResult: "loser",  slot2SourceFrom: 8,  slot2SourceResult: "loser" },
    29: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 9,  slot1SourceResult: "loser",  slot2SourceFrom: 10, slot2SourceResult: "loser" },
    30: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 11, slot1SourceResult: "loser",  slot2SourceFrom: 12, slot2SourceResult: "loser" },
    31: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 13, slot1SourceResult: "loser",  slot2SourceFrom: 14, slot2SourceResult: "loser" },
    32: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 15, slot1SourceResult: "loser",  slot2SourceFrom: 16, slot2SourceResult: "loser" },

    // 2da RONDA PERDEDORES (puede ajustarse según tu Excel masculino final)
    33: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 25, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "loser"  },
    34: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 26, slot1SourceResult: "winner", slot2SourceFrom: 23, slot2SourceResult: "loser"  },
    35: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 27, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "loser"  },
    36: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 28, slot1SourceResult: "winner", slot2SourceFrom: 21, slot2SourceResult: "loser"  },
    37: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 29, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "loser"  },
    38: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 30, slot1SourceResult: "winner", slot2SourceFrom: 19, slot2SourceResult: "loser"  },
    39: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 31, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "loser"  },
    40: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 32, slot1SourceResult: "winner", slot2SourceFrom: 17, slot2SourceResult: "loser"  },

    // 3ra RONDA PERDEDORES
    41: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 33, slot1SourceResult: "winner", slot2SourceFrom: 34, slot2SourceResult: "winner" },
    42: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 35, slot1SourceResult: "winner", slot2SourceFrom: 36, slot2SourceResult: "winner" },
    43: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 37, slot1SourceResult: "winner", slot2SourceFrom: 38, slot2SourceResult: "winner" },
    44: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 39, slot1SourceResult: "winner", slot2SourceFrom: 40, slot2SourceResult: "winner" },

    // 3ra RONDA (ganadores)
    45: { roundLabel: "3ra ronda",        slot1SourceFrom: 17, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "winner" },
    46: { roundLabel: "3ra ronda",        slot1SourceFrom: 19, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "winner" },
    47: { roundLabel: "3ra ronda",        slot1SourceFrom: 21, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "winner" },
    48: { roundLabel: "3ra ronda",        slot1SourceFrom: 23, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "winner" },

    // 4ta RONDA PERDEDORES
    49: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 41, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "loser" },
    50: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 42, slot1SourceResult: "winner", slot2SourceFrom: 45, slot2SourceResult: "loser" },
    51: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 43, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "loser" },
    52: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 44, slot1SourceResult: "winner", slot2SourceFrom: 47, slot2SourceResult: "loser" },

    // PASE A SEMI (ganadores)
    53: { roundLabel: "Pase a semi",      slot1SourceFrom: 45, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "winner" },
    54: { roundLabel: "Pase a semi",      slot1SourceFrom: 47, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "winner" },

    // 5ta RONDA PERDEDORES
    55: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 49, slot1SourceResult: "winner", slot2SourceFrom: 50, slot2SourceResult: "winner" },
    56: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 51, slot1SourceResult: "winner", slot2SourceFrom: 52, slot2SourceResult: "winner" },

    // PASE A SEMI (perdedores)
    57: { roundLabel: "Pase a semi",      slot1SourceFrom: 55, slot1SourceResult: "winner", slot2SourceFrom: 54, slot2SourceResult: "loser"  },
    58: { roundLabel: "Pase a semi",      slot1SourceFrom: 56, slot1SourceResult: "winner", slot2SourceFrom: 53, slot2SourceResult: "loser"  },

    // SEMIFINALES
    59: { roundLabel: "Semi 1",           slot1SourceFrom: 53, slot1SourceResult: "winner", slot2SourceFrom: 57, slot2SourceResult: "winner" },
    60: { roundLabel: "Semi 2",           slot1SourceFrom: 54, slot1SourceResult: "winner", slot2SourceFrom: 58, slot2SourceResult: "winner" },

    // 3er PUESTO
    61: { roundLabel: "3er puesto",       slot1SourceFrom: 59, slot1SourceResult: "loser",  slot2SourceFrom: 60, slot2SourceResult: "loser"  },

    // FINAL
    62: { roundLabel: "Final",            slot1SourceFrom: 59, slot1SourceResult: "winner", slot2SourceFrom: 60, slot2SourceResult: "winner" }
  };

  // ============================
  // 3) CONFIG FEMENINO – 16 EQUIPOS, 30 PARTIDOS
  // ============================

  const MAIN_DRAW_CONFIG_F_16 = {
    1:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    2:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    3:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    4:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    5:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    6:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    7:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    8:  { roundLabel: "1ra ronda",   slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },

    9:  { roundLabel: "2da ronda",   slot1SourceFrom: 1,  slot1SourceResult: "winner", slot2SourceFrom: 2,  slot2SourceResult: "winner" },
    10: { roundLabel: "2da ronda",   slot1SourceFrom: 3,  slot1SourceResult: "winner", slot2SourceFrom: 4,  slot2SourceResult: "winner" },
    11: { roundLabel: "2da ronda",   slot1SourceFrom: 5,  slot1SourceResult: "winner", slot2SourceFrom: 6,  slot2SourceResult: "winner" },
    12: { roundLabel: "2da ronda",   slot1SourceFrom: 7,  slot1SourceResult: "winner", slot2SourceFrom: 8,  slot2SourceResult: "winner" },

    13: { roundLabel: "1er ronda perd.", slot1SourceFrom: 8, slot1SourceResult: "loser", slot2SourceFrom: 5, slot2SourceResult: "loser" },
    14: { roundLabel: "1er ronda perd.", slot1SourceFrom: 6, slot1SourceResult: "loser", slot2SourceFrom: 3, slot2SourceResult: "loser" },
    15: { roundLabel: "1er ronda perd.", slot1SourceFrom: 4, slot1SourceResult: "loser", slot2SourceFrom: 1, slot2SourceResult: "loser" },
    16: { roundLabel: "1er ronda perd.", slot1SourceFrom: 7, slot1SourceResult: "loser", slot2SourceFrom: 2, slot2SourceResult: "loser" },

    17: { roundLabel: "2da ronda perd.", slot1SourceFrom: 13, slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "loser" },
    18: { roundLabel: "2da ronda perd.", slot1SourceFrom: 14, slot1SourceResult: "winner", slot2SourceFrom: 9,  slot2SourceResult: "loser" },
    19: { roundLabel: "2da ronda perd.", slot1SourceFrom: 15, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "loser" },
    20: { roundLabel: "2da ronda perd.", slot1SourceFrom: 16, slot1SourceResult: "winner", slot2SourceFrom: 11, slot2SourceResult: "loser" },

    21: { roundLabel: "Pase a semi",      slot1SourceFrom: 9,  slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "winner" },
    22: { roundLabel: "Pase a semi",      slot1SourceFrom: 11, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "winner" },

    23: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 17, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "winner" },
    24: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 19, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "winner" },

    25: { roundLabel: "Pase a semi",      slot1SourceFrom: 23, slot1SourceResult: "winner", slot2SourceFrom: 21, slot2SourceResult: "loser"  },
    26: { roundLabel: "Pase a semi",      slot1SourceFrom: 24, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "loser"  },

    27: { roundLabel: "Semi",             slot1SourceFrom: 25, slot1SourceResult: "winner", slot2SourceFrom: 21, slot2SourceResult: "winner" },
    28: { roundLabel: "Semi",             slot1SourceFrom: 26, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "winner" },

    29: { roundLabel: "3er puesto",       slot1SourceFrom: 27, slot1SourceResult: "loser",  slot2SourceFrom: 28, slot2SourceResult: "loser"  },

    30: { roundLabel: "Final",            slot1SourceFrom: 27, slot1SourceResult: "winner", slot2SourceFrom: 28, slot2SourceResult: "winner" }
  };

  // ============================
  // 4) RANKING (igual criterio que tabla general)
  // ============================

  function normalizeCategoria(c){
    if(!c) return "";
    const up = c.toString().toUpperCase();
    if(up.startsWith("F")) return "F";
    if(up.startsWith("M")) return "M";
    return up;
  }

  function normalizeZona(z){
    return (z || "").toString().trim().toUpperCase();
  }

  function calcCoef(t){
    if (t.ptsLost === 0){
      return t.ptsWon > 0 ? t.ptsWon : 0;
    }
    return t.ptsWon / t.ptsLost;
  }

  function compareTeams(a,b){
    if(b.tablePts !== a.tablePts) return b.tablePts - a.tablePts;
    const diffA = a.ptsWon - a.ptsLost;
    const diffB = b.ptsWon - b.ptsLost;
    if(diffB !== diffA) return diffB - diffA;
    const coefA = calcCoef(a);
    const coefB = calcCoef(b);
    if(coefB !== coefA) return coefB - coefA;
    return (a.teamName || "").localeCompare(b.teamName || "");
  }

  function computeStandingsByZone(matches, categoriaFiltro){
    const map = new Map();

    matches.forEach(m => {
      if(m.categoria !== categoriaFiltro) return;

      const zona = m.zona || "SIN ZONA";
      [m.localName, m.visitanteName].forEach(name => {
        if(!name) return;
        const key = `${name}|${categoriaFiltro}|${zona}`;
        if(!map.has(key)){
          map.set(key, {
            teamName: name,
            categoria: categoriaFiltro,
            zona,
            played: 0,
            wins: 0,
            losses: 0,
            ptsWon: 0,
            ptsLost: 0,
            tablePts: 0
          });
        }
      });
    });

    const PTS_WIN  = 2;
    const PTS_LOSS = 1;

    matches.forEach(m => {
      if(m.categoria !== categoriaFiltro) return;
      if(m.estado !== "Finalizado") return;

      const zona = m.zona || "SIN ZONA";
      const { localName, visitanteName } = m;
      if(!localName || !visitanteName) return;

      let ptsLocal = 0;
      let ptsVisit = 0;
      if(Array.isArray(m.setsData)){
        m.setsData.forEach(s => {
          ptsLocal += s.puntosLocal ?? 0;
          ptsVisit += s.puntosVisitante ?? 0;
        });
      }
      if(ptsLocal === 0 && ptsVisit === 0) return;

      const localKey = `${localName}|${m.categoria}|${zona}`;
      const visitKey = `${visitanteName}|${m.categoria}|${zona}`;

      const localStat = map.get(localKey);
      const visitStat = map.get(visitKey);

      localStat.played++;
      visitStat.played++;

      localStat.ptsWon  += ptsLocal;
      localStat.ptsLost += ptsVisit;
      visitStat.ptsWon  += ptsVisit;
      visitStat.ptsLost += ptsLocal;

      if(ptsLocal > ptsVisit){
        localStat.wins++;
        visitStat.losses++;
        localStat.tablePts += PTS_WIN;
        visitStat.tablePts += PTS_LOSS;
      } else {
        visitStat.wins++;
        localStat.losses++;
        visitStat.tablePts += PTS_WIN;
        localStat.tablePts += PTS_LOSS;
      }
    });

    const zonasMap = {};
    for(const s of map.values()){
      const z = s.zona;
      if(!zonasMap[z]) zonasMap[z] = [];
      zonasMap[z].push(s);
    }

    Object.keys(zonasMap).forEach(z => zonasMap[z].sort(compareTeams));
    return zonasMap;
  }

  function computeGlobalStandings(matches, categoriaFiltro){
    const zonasMap = computeStandingsByZone(matches, categoriaFiltro);
    const firsts = [], seconds = [], thirds = [], others = [];

    Object.keys(zonasMap).forEach(z => {
      const lista = zonasMap[z];
      lista.forEach((t, idx) => {
        const withMeta = { ...t, zoneName: z, posZona: idx + 1 };
        if(idx === 0) firsts.push(withMeta);
        else if(idx === 1) seconds.push(withMeta);
        else if(idx === 2) thirds.push(withMeta);
        else others.push(withMeta);
      });
    });

    firsts.sort(compareTeams);
    seconds.sort(compareTeams);
    thirds.sort(compareTeams);
    others.sort(compareTeams);

    return [...firsts, ...seconds, ...thirds, ...others];
  }

  async function fetchRankingForRama(rama) {
    const snap = await getDocs(collection(db, "matches"));
    const all = [];

    snap.forEach(docSnap => {
      const d = docSnap.data();
      all.push({
        localName: d.localName || "",
        visitanteName: d.visitanteName || "",
        categoria: normalizeCategoria(d.categoria || d.category),
        zona: normalizeZona(d.zona || d.zone),
        estado: d.estado || "Pendiente",
        setsData: d.setsData || []
      });
    });

    return computeGlobalStandings(all, rama);
  }

  // ============================
  // 5) ESTADO DEL CUADRO
  // ============================

  async function checkMainDrawStatus(rama) {
    mainDrawStatus.textContent = "Revisando cuadro...";

    const q = query(
      collection(db, "matches"),
      where("phase", "==", "maindraw"),
      where("rama", "==", rama)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      mainDrawStatus.textContent = `No hay cuadro generado para ${rama === "F" ? "Femenino" : "Masculino"}.`;
    } else {
      mainDrawStatus.textContent = `Ya hay ${snap.size} partidos de cuadro generados para ${rama === "F" ? "Femenino" : "Masculino"}.`;
    }
  }

  // ============================
  // 6) GENERAR CUADRO DESDE RANKING
  // ============================

  async function generateMainDrawFromRanking(rama) {
    try {
      mainDrawStatus.textContent = "Verificando que no exista ya un cuadro...";

      const existingQ = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );
      const existingSnap = await getDocs(existingQ);

      if (!existingSnap.empty) {
        mainDrawStatus.textContent = `⚠️ Ya existe un cuadro para ${rama === "F" ? "Femenino" : "Masculino"}. Borrá esos partidos manualmente si querés regenerarlo.`;
        return;
      }

      mainDrawStatus.textContent = "Leyendo ranking general...";
      const ranking = await fetchRankingForRama(rama);

      const isMasculino   = (rama === "M");
      const requiredCount = isMasculino ? 32 : 16;
      const labelRama     = isMasculino ? "MASCULINO" : "FEMENINO";

      if (!ranking || ranking.length < requiredCount) {
        mainDrawStatus.textContent = `❌ El ranking de ${labelRama} tiene menos de ${requiredCount} equipos (encontrados: ${ranking ? ranking.length : 0}).`;
        return;
      }

      const topN = ranking.slice(0, requiredCount);

      const nombres = topN
        .map((t, idx) => `${idx+1}. ${t.teamName || t.equipo || "SinNombre"}`)
        .join("\n");

      const msgConfirm =
        `Se va a generar el cuadro principal para ${labelRama} con los primeros ${requiredCount} equipos del ranking general:\n\n` +
        `${nombres}\n\n` +
        `¿Confirmás que querés generar el cuadro con estos equipos?`;

      const ok = window.confirm(msgConfirm);
      if (!ok) {
        mainDrawStatus.textContent = "Operación cancelada. No se generó el cuadro.";
        return;
      }

      const seedByNumber = {};
      topN.forEach((item, idx) => {
        const seedNum = idx + 1;
        seedByNumber[seedNum] = {
          teamId: item.teamId || null,
          teamName: item.teamName || item.equipo || `Seed ${seedNum}`
        };
      });

      const CONFIG       = isMasculino ? MAIN_DRAW_CONFIG_32 : MAIN_DRAW_CONFIG_F_16;
      const SEED_MAP     = isMasculino ? FIRST_ROUND_SEED_MAP : FIRST_ROUND_SEED_MAP_F;
      const MAX_MATCHES  = isMasculino ? 62 : 30;

      mainDrawStatus.textContent = "Generando documentos de partidos del cuadro...";

      const batch      = writeBatch(db);
      const matchesCol = collection(db, "matches");

      for (let matchNum = 1; matchNum <= MAX_MATCHES; matchNum++) {
        const cfg = CONFIG[matchNum];
        if (!cfg) continue;

        const docRef = doc(matchesCol);

        const baseData = {
          phase: "maindraw",
          rama,
          drawMatchNumber: matchNum,
          roundLabel: cfg.roundLabel,
          status: "pending",
          team1Id: null,
          team1Name: null,
          team2Id: null,
          team2Name: null,
          slot1SourceFrom: cfg.slot1SourceFrom ?? null,
          slot1SourceResult: cfg.slot1SourceResult ?? null,
          slot2SourceFrom: cfg.slot2SourceFrom ?? null,
          slot2SourceResult: cfg.slot2SourceResult ?? null
        };

        const seedMap = SEED_MAP.find(m => m.match === matchNum);
        if (seedMap) {
          const s1 = seedByNumber[seedMap.seed1];
          const s2 = seedByNumber[seedMap.seed2];

          if (s1) {
            baseData.team1Id   = s1.teamId;
            baseData.team1Name = s1.teamName;
          }
          if (s2) {
            baseData.team2Id   = s2.teamId;
            baseData.team2Name = s2.teamName;
          }
        }

        batch.set(docRef, baseData);
      }

      await batch.commit();

      mainDrawStatus.textContent = `✅ Se generó el cuadro principal de ${labelRama} con los primeros ${requiredCount} equipos del ranking. Podés verlo en bracket.html.`;

    } catch (err) {
      console.error(err);
      mainDrawStatus.textContent = "❌ Error generando el cuadro. Revisá la consola.";
    }
  }

</script>

</body>
</html>
