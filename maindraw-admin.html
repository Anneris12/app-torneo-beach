<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Cuadro principal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      background: #031926;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }

    /* Botones superiores */
    .top-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-btn {
      background: #ffe36a;
      color: #000;
      font-weight: bold;
      padding: 10px 16px;
      border-radius: 12px;
      text-decoration: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    /* Título */
    h1 {
      text-align: center;
      margin-top: 0;
      text-transform: uppercase;
    }

    /* Panel central */
    .panel {
      max-width: 800px;
      margin: 0 auto;
      background: #052235;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .panel h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .panel p {
      font-size: 14px;
      color: #d0d0d0;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    .controls label {
      font-size: 14px;
      font-weight: 600;
    }

    .controls select {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.08);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 14px;
    }

    .controls button {
      border-radius: 10px;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .btn-primary {
      background: #ffe36a;
      color: #000;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.08);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }

    #mainDrawStatus {
      margin-top: 10px;
      font-size: 14px;
      min-height: 24px;
      white-space: pre-line;
    }

    /* Preview card */
    .preview-card {
      margin-top: 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .preview-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .preview-sub {
      margin: 4px 0 0 0;
      color: #d0d0d0;
      font-size: 13px;
    }

    .preview-meta {
      font-size: 13px;
      color: #ffe36a;
      font-weight: 700;
    }

    .preview-table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 10px;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .preview-table th,
    .preview-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
      white-space: nowrap;
    }

    .preview-table th {
      color: #ffe36a;
      font-weight: 700;
    }

    .preview-empty {
      text-align: center;
      color: #b0b0b0;
      padding: 10px 0;
    }

    @media (max-width: 480px) {
      .panel {
        padding: 15px;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>

<div class="top-buttons">
  <a class="top-btn" href="admin.html">Volver</a>
  <a class="top-btn" href="bracket.html">Ver cuadro (tabla)</a>
  <a class="top-btn" href="bracket-visual.html">Ver cuadro (llaves)</a>
</div>

<h1>ADMIN CUADRO PRINCIPAL</h1>

<main>
  <div class="panel">
    <h2>Configurar cuadro principal (Main Draw)</h2>
    <p>
      Paso 1: Importar los partidos del cuadro (1 al 62) con número de partido, ronda, cruce, fecha, hora y cancha.<br>
      Paso 2: Asignar los equipos de la 1ra ronda según el ranking general.
    </p>

    <div class="controls">
      <label for="mainDrawRama">Rama:</label>
      <select id="mainDrawRama">
        <option value="F">Femenino</option>
        <option value="M">Masculino</option>
      </select>

      <button id="btnCheckMainDraw" type="button" class="btn-secondary">
        Ver estado del cuadro
      </button>

      <button id="btnImportMainDraw" type="button" class="btn-secondary">
        Importar partidos (CSV)
      </button>

      <button id="btnExportMainDraw" type="button" class="btn-secondary">
        Exportar partidos (CSV)
      </button>

      <button id="btnAssignFromRanking" type="button" class="btn-primary">
        Asignar equipos según ranking
      </button>
    </div>

    <p style="font-size:13px; color:#b0b0b0; margin-top:0;">
      Formato CSV esperado (1ra fila encabezados):<br>
      <code>numeroPartido;ronda;cruce;fecha;hora;cancha</code><br>
      Ej: <code>1;1ra ronda;1 vs 32;2026-02-01;08:00;1</code>
    </p>

    <div id="mainDrawStatus"></div>

    <div id="previewCard" class="preview-card" style="display:none;">
      <div class="preview-header">
        <div>
          <h3>Previsualización de partidos</h3>
          <p class="preview-sub">
            Estos son los partidos detectados en el CSV antes de subirlos. Una vez creados
            podrás verlos también en <strong>/bracket</strong>.
          </p>
        </div>
        <div class="preview-meta" id="previewMeta"></div>
      </div>

      <div class="preview-table-wrapper">
        <table class="preview-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Ronda</th>
              <th>Cruce</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Cancha</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>

    <!-- input de archivo oculto -->
    <input type="file" id="fileInput" accept=".csv" style="display:none" />
  </div>
</main>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    writeBatch,
    doc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
    authDomain: "torneo-beach.firebaseapp.com",
    projectId: "torneo-beach",
    storageBucket: "torneo-beach.firebasestorage.app",
    messagingSenderId: "21136645638",
    appId: "1:21136645638:web:52c3b06affc2ee151eed87"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // proteger acceso
  onAuthStateChanged(auth, u => {
    if (!u) location.href = "login.html";
  });

  const mainDrawRamaSelect   = document.getElementById("mainDrawRama");
  const btnCheckMainDraw     = document.getElementById("btnCheckMainDraw");
  const btnImportMainDraw    = document.getElementById("btnImportMainDraw");
  const btnExportMainDraw    = document.getElementById("btnExportMainDraw");
  const btnAssignFromRanking = document.getElementById("btnAssignFromRanking");
  const mainDrawStatus       = document.getElementById("mainDrawStatus");
  const fileInput            = document.getElementById("fileInput");
  const previewCard          = document.getElementById("previewCard");
  const previewBody          = document.getElementById("previewBody");
  const previewMeta          = document.getElementById("previewMeta");

  btnCheckMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    checkMainDrawStatus(rama);
  });

  btnImportMainDraw.addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const rama = mainDrawRamaSelect.value;
    await importMainDrawFromFile(file, rama);
    fileInput.value = "";
  });

  btnExportMainDraw.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    exportMainDrawToCSV(rama);
  });

  btnAssignFromRanking.addEventListener("click", () => {
    const rama = mainDrawRamaSelect.value;
    assignTeamsFromRanking(rama);
  });

  /* ============================
   * Helpers
   * ============================ */

  function normalizeHoraImport(h){
    if(!h) return "";
    let s = String(h).trim();

    // Si ya viene en formato H:MM / HH:MM lo dejamos
    if(/^\d{1,2}:\d{2}$/.test(s)) return s;

    // Sacamos todo lo que no sea dígito
    const dig = s.replace(/\D/g,"");

    if (dig.length === 3) {
      // 800 -> 8:00
      return dig[0] + ":" + dig.substring(1).padEnd(2,"0");
    }
    if (dig.length === 4) {
      // 0830 -> 08:30
      return dig.substring(0,2) + ":" + dig.substring(2);
    }

    // Si es raro, lo dejamos como vino
    return s;
  }

  function renderPreview(matches, rama){
    if(!matches || matches.length === 0){
      previewCard.style.display = "none";
      previewBody.innerHTML = "";
      previewMeta.textContent = "";
      return;
    }

    previewCard.style.display = "block";
    previewBody.innerHTML = "";
    previewMeta.textContent = `${matches.length} partidos - Rama ${rama === "F" ? "Femenino" : "Masculino"}`;

    matches
      .slice()
      .sort((a,b) => (a.matchNum||0) - (b.matchNum||0))
      .forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.matchNum ?? ""}</td>
          <td>${m.roundLabel || ""}</td>
          <td>${m.cruce || ""}</td>
          <td>${m.fecha || ""}</td>
          <td>${m.hora || ""}</td>
          <td>${m.cancha || ""}</td>
        `;
        previewBody.appendChild(tr);
      });

    if(previewBody.children.length === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.className = "preview-empty";
      td.textContent = "No se detectaron partidos válidos en el CSV.";
      tr.appendChild(td);
      previewBody.appendChild(tr);
    }
  }

  /* ============================
   * 1) CONFIG ESTRUCTURAL DEL CUADRO
   * ============================ */

  const FIRST_ROUND_SEED_MAP_16 = [
    { match: 1, seed1: 1,  seed2: 16 },
    { match: 2, seed1: 8,  seed2: 9 },
    { match: 3, seed1: 5,  seed2: 12 },
    { match: 4, seed1: 4,  seed2: 13 },
    { match: 5, seed1: 3,  seed2: 14 },
    { match: 6, seed1: 6,  seed2: 11 },
    { match: 7, seed1: 7,  seed2: 10 },
    { match: 8, seed1: 2,  seed2: 15 }
  ];

  const FIRST_ROUND_SEED_MAP_32 = [
    { match: 1,  seed1: 1,  seed2: 32 },
    { match: 2,  seed1: 17, seed2: 16 },
    { match: 3,  seed1: 9,  seed2: 24 },
    { match: 4,  seed1: 25, seed2: 8 },
    { match: 5,  seed1: 5,  seed2: 28 },
    { match: 6,  seed1: 21, seed2: 12 },
    { match: 7,  seed1: 13, seed2: 20 },
    { match: 8,  seed1: 29, seed2: 4 },
    { match: 9,  seed1: 3,  seed2: 30 },
    { match: 10, seed1: 19, seed2: 14 },
    { match: 11, seed1: 11, seed2: 22 },
    { match: 12, seed1: 27, seed2: 6 },
    { match: 13, seed1: 7,  seed2: 26 },
    { match: 14, seed1: 23, seed2: 10 },
    { match: 15, seed1: 15, seed2: 18 },
    { match: 16, seed1: 31, seed2: 2 }
  ];

  const MAIN_DRAW_CONFIG_16 = {
    1:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    2:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    3:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    4:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    5:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    6:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    7:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    8:  { roundLabel: "1ra ronda",  slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },

    9:  { roundLabel: "2da ronda",  slot1SourceFrom: 1, slot1SourceResult: "winner", slot2SourceFrom: 2, slot2SourceResult: "winner" },
    10: { roundLabel: "2da ronda",  slot1SourceFrom: 3, slot1SourceResult: "winner", slot2SourceFrom: 4, slot2SourceResult: "winner" },
    11: { roundLabel: "2da ronda",  slot1SourceFrom: 5, slot1SourceResult: "winner", slot2SourceFrom: 6, slot2SourceResult: "winner" },
    12: { roundLabel: "2da ronda",  slot1SourceFrom: 7, slot1SourceResult: "winner", slot2SourceFrom: 8, slot2SourceResult: "winner" },

    13: { roundLabel: "Semifinal", slot1SourceFrom: 9,  slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "winner" },
    14: { roundLabel: "Semifinal", slot1SourceFrom: 11, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "winner" },

    15: { roundLabel: "Final",     slot1SourceFrom: 13, slot1SourceResult: "winner", slot2SourceFrom: 14, slot2SourceResult: "winner" },
    16: { roundLabel: "3er puesto", slot1SourceFrom: 13, slot1SourceResult: "loser",  slot2SourceFrom: 14, slot2SourceResult: "loser" }
  };

  const MAIN_DRAW_CONFIG_32 = {
    1:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    2:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    3:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    4:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    5:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    6:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    7:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    8:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    9:  { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    10: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    11: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    12: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    13: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    14: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    15: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },
    16: { roundLabel: "1ra ronda",        slot1SourceFrom: null, slot1SourceResult: null,  slot2SourceFrom: null, slot2SourceResult: null },

    17: { roundLabel: "2da ronda",        slot1SourceFrom: 1,  slot1SourceResult: "winner", slot2SourceFrom: 2,  slot2SourceResult: "winner" },
    18: { roundLabel: "2da ronda",        slot1SourceFrom: 3,  slot1SourceResult: "winner", slot2SourceFrom: 4,  slot2SourceResult: "winner" },
    19: { roundLabel: "2da ronda",        slot1SourceFrom: 5,  slot1SourceResult: "winner", slot2SourceFrom: 6,  slot2SourceResult: "winner" },
    20: { roundLabel: "2da ronda",        slot1SourceFrom: 7,  slot1SourceResult: "winner", slot2SourceFrom: 8,  slot2SourceResult: "winner" },
    21: { roundLabel: "2da ronda",        slot1SourceFrom: 9,  slot1SourceResult: "winner", slot2SourceFrom: 10, slot2SourceResult: "winner" },
    22: { roundLabel: "2da ronda",        slot1SourceFrom: 11, slot1SourceResult: "winner", slot2SourceFrom: 12, slot2SourceResult: "winner" },
    23: { roundLabel: "2da ronda",        slot1SourceFrom: 13, slot1SourceResult: "winner", slot2SourceFrom: 14, slot2SourceResult: "winner" },
    24: { roundLabel: "2da ronda",        slot1SourceFrom: 15, slot1SourceResult: "winner", slot2SourceFrom: 16, slot2SourceResult: "winner" },

    25: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 1,  slot1SourceResult: "loser",  slot2SourceFrom: 2,  slot2SourceResult: "loser" },
    26: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 3,  slot1SourceResult: "loser",  slot2SourceFrom: 4,  slot2SourceResult: "loser" },
    27: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 5,  slot1SourceResult: "loser",  slot2SourceFrom: 6,  slot2SourceResult: "loser" },
    28: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 7,  slot1SourceResult: "loser",  slot2SourceFrom: 8,  slot2SourceResult: "loser" },
    29: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 9,  slot1SourceResult: "loser",  slot2SourceFrom: 10, slot2SourceResult: "loser" },
    30: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 11, slot1SourceResult: "loser",  slot2SourceFrom: 12, slot2SourceResult: "loser" },
    31: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 13, slot1SourceResult: "loser",  slot2SourceFrom: 14, slot2SourceResult: "loser" },
    32: { roundLabel: "1er ronda perd.",  slot1SourceFrom: 15, slot1SourceResult: "loser",  slot2SourceFrom: 16, slot2SourceResult: "loser" },

    33: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 25, slot1SourceResult: "winner", slot2SourceFrom: 23, slot2SourceResult: "loser" },
    34: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 26, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "loser" },
    35: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 27, slot1SourceResult: "winner", slot2SourceFrom: 21, slot2SourceResult: "loser" },
    36: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 28, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "loser" },
    37: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 29, slot1SourceResult: "winner", slot2SourceFrom: 17, slot2SourceResult: "loser" },
    38: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 30, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "loser" },
    39: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 31, slot1SourceResult: "winner", slot2SourceFrom: 19, slot2SourceResult: "loser" },
    40: { roundLabel: "2da ronda perd.",  slot1SourceFrom: 32, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "loser" },

    41: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 33, slot1SourceResult: "winner", slot2SourceFrom: 34, slot2SourceResult: "winner" },
    42: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 35, slot1SourceResult: "winner", slot2SourceFrom: 36, slot2SourceResult: "winner" },
    43: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 37, slot1SourceResult: "winner", slot2SourceFrom: 38, slot2SourceResult: "winner" },
    44: { roundLabel: "3ra ronda perd.",  slot1SourceFrom: 39, slot1SourceResult: "winner", slot2SourceFrom: 40, slot2SourceResult: "winner" },

    45: { roundLabel: "3ra ronda",        slot1SourceFrom: 17, slot1SourceResult: "winner", slot2SourceFrom: 18, slot2SourceResult: "winner" },
    46: { roundLabel: "3ra ronda",        slot1SourceFrom: 19, slot1SourceResult: "winner", slot2SourceFrom: 20, slot2SourceResult: "winner" },
    47: { roundLabel: "3ra ronda",        slot1SourceFrom: 21, slot1SourceResult: "winner", slot2SourceFrom: 22, slot2SourceResult: "winner" },
    48: { roundLabel: "3ra ronda",        slot1SourceFrom: 23, slot1SourceResult: "winner", slot2SourceFrom: 24, slot2SourceResult: "winner" },

    49: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 41, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "loser" },
    50: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 42, slot1SourceResult: "winner", slot2SourceFrom: 45, slot2SourceResult: "loser" },
    51: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 43, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "loser" },
    52: { roundLabel: "4ta ronda perd.",  slot1SourceFrom: 44, slot1SourceResult: "winner", slot2SourceFrom: 47, slot2SourceResult: "loser" },

    53: { roundLabel: "Pase a semi",      slot1SourceFrom: 45, slot1SourceResult: "winner", slot2SourceFrom: 46, slot2SourceResult: "winner" },
    54: { roundLabel: "Pase a semi",      slot1SourceFrom: 47, slot1SourceResult: "winner", slot2SourceFrom: 48, slot2SourceResult: "winner" },

    55: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 49, slot1SourceResult: "winner", slot2SourceFrom: 50, slot2SourceResult: "winner" },
    56: { roundLabel: "5ta ronda perd.",  slot1SourceFrom: 51, slot1SourceResult: "winner", slot2SourceFrom: 52, slot2SourceResult: "winner" },

    57: { roundLabel: "Pase a semi",      slot1SourceFrom: 55, slot1SourceResult: "winner", slot2SourceFrom: 54, slot2SourceResult: "loser" },
    58: { roundLabel: "Pase a semi",      slot1SourceFrom: 56, slot1SourceResult: "winner", slot2SourceFrom: 53, slot2SourceResult: "loser" },

    59: { roundLabel: "Semi 1",           slot1SourceFrom: 53, slot1SourceResult: "winner", slot2SourceFrom: 57, slot2SourceResult: "winner" },
    60: { roundLabel: "Semi 2",           slot1SourceFrom: 54, slot1SourceResult: "winner", slot2SourceFrom: 58, slot2SourceResult: "winner" },

    61: { roundLabel: "3er puesto",       slot1SourceFrom: 59, slot1SourceResult: "loser",  slot2SourceFrom: 60, slot2SourceResult: "loser" },
    62: { roundLabel: "Final",            slot1SourceFrom: 59, slot1SourceResult: "winner", slot2SourceFrom: 60, slot2SourceResult: "winner" }
  };

  function getMainDrawConfig(rama) {
    return rama === "F" ? MAIN_DRAW_CONFIG_16 : MAIN_DRAW_CONFIG_32;
  }

  function getFirstRoundSeedMap(rama) {
    return rama === "F" ? FIRST_ROUND_SEED_MAP_16 : FIRST_ROUND_SEED_MAP_32;
  }

  function parseSeedsFromCruce(cruce) {
    if (!cruce) return null;
    const match = cruce.toString().match(/(\d+)\s*vs\s*(\d+)/i);
    if (!match) return null;
    return {
      seed1: parseInt(match[1], 10),
      seed2: parseInt(match[2], 10)
    };
  }

  /* ============================
   * 2) ESTADO DEL CUADRO
   * ============================ */

  async function checkMainDrawStatus(rama) {
    mainDrawStatus.textContent = "Revisando cuadro...";

    const q = query(
      collection(db, "matches"),
      where("phase", "==", "maindraw"),
      where("rama", "==", rama)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      mainDrawStatus.textContent = `No hay partidos de cuadro cargados para ${rama === "F" ? "Femenino" : "Masculino"}.\nImportá el CSV primero.`;
    } else {
      mainDrawStatus.textContent = `Hay ${snap.size} partidos de cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.\nLuego podés asignar equipos de 1ra ronda según el ranking.`;
    }
  }

  /* ============================
   * 3) IMPORTAR PARTIDOS DESDE CSV
   * ============================ */

  async function importMainDrawFromFile(file, rama) {
    try {
      mainDrawStatus.textContent = "Leyendo archivo CSV...";
      renderPreview([], rama);
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) {
        mainDrawStatus.textContent = "El archivo no tiene datos (necesita encabezados y filas).";
        return;
      }

      const headerLine = lines[0];
      const sep = headerLine.includes(";") ? ";" : ",";
      const headersRaw = headerLine.split(sep).map(h => h.trim());
      const headers = headersRaw.map(h => h.toLowerCase());

      const idxNum = headers.findIndex(h =>
        [
          "numero",
          "numeropartido",
          "numero_partido",
          "numpartido",
          "#",
          "partido",
          "match",
          "drawmatchnumber"
        ].includes(h)
      );

      const idxRonda = headers.findIndex(h =>
        ["ronda", "round", "roundlabel"].includes(h)
      );

      const idxCruce = headers.findIndex(h => h.includes("cruce"));
      const idxFecha = headers.findIndex(h => h.startsWith("fecha"));
      const idxHora  = headers.findIndex(h => h.startsWith("hora"));
      const idxCancha= headers.findIndex(h => h.startsWith("cancha"));

      if (idxNum === -1 || idxCruce === -1 || idxFecha === -1 || idxHora === -1 || idxCancha === -1) {
        mainDrawStatus.textContent =
          "No se encontraron las columnas requeridas en el CSV.\n" +
          "Necesita al menos: numeroPartido, cruce, fecha, hora, cancha.";
        return;
      }

      // borrar partidos previos de esta rama
      mainDrawStatus.textContent = "Eliminando partidos anteriores del cuadro para esta rama...";
      const existingQ = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );
      const existingSnap = await getDocs(existingQ);

      if (!existingSnap.empty) {
        const batchDel = writeBatch(db);
        existingSnap.forEach(docSnap => {
          batchDel.delete(docSnap.ref);
        });
        await batchDel.commit();
      }

      mainDrawStatus.textContent = "Validando partidos y armando la previsualización...";

      const parsedMatches = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const partsRaw = line.split(sep);
        const parts = partsRaw.map(x => (x ?? "").toString().trim());

        const numStr = parts[idxNum] || "";
        if (!numStr) continue;

        const matchNum = parseInt(numStr, 10);
        if (isNaN(matchNum)) continue;

    const cfg = getMainDrawConfig(rama)[matchNum] || {
          roundLabel: rondaCSV || "",
          slot1SourceFrom: null,
          slot1SourceResult: null,
          slot2SourceFrom: null,
          slot2SourceResult: null
        };

        const cruceVal = parts[idxCruce] || "";
        const fechaVal = parts[idxFecha] || "";
        const horaVal  = parts[idxHora]  || "";
        const canchaVal= parts[idxCancha] || "";
        const rondaCSV = idxRonda >= 0 ? (parts[idxRonda] || "") : "";

        let cruceFinal = cruceVal;
        if (!cruceFinal) {
          const seedMap = getFirstRoundSeedMap(rama).find(m => m.match === matchNum);
          if (seedMap) {
            cruceFinal = `${seedMap.seed1} vs ${seedMap.seed2}`;
          }
        }

        parsedMatches.push({
          matchNum,
          roundLabel: rondaCSV || cfg.roundLabel,
          cruce: cruceFinal || null,
          cancha: canchaVal || null,
          fecha: fechaVal || null,
          hora: normalizeHoraImport(horaVal) || null,
          slot1SourceFrom: cfg.slot1SourceFrom ?? null,
          slot1SourceResult: cfg.slot1SourceResult ?? null,
          slot2SourceFrom: cfg.slot2SourceFrom ?? null,
          slot2SourceResult: cfg.slot2SourceResult ?? null
        });
      }

      renderPreview(parsedMatches, rama);

      if(parsedMatches.length === 0){
        mainDrawStatus.textContent = "No se encontraron partidos válidos en el CSV para crear.";
        return;
      }

      mainDrawStatus.textContent = "Creando partidos del cuadro a partir del CSV...";

      const matchesCol = collection(db, "matches");
      const batch = writeBatch(db);
      let totalRows = 0;

      parsedMatches.forEach(m => {
        const docRef = doc(matchesCol);
        const baseData = {
          phase: "maindraw",
          rama,
          categoria: rama,
          drawMatchNumber: m.matchNum,
          numeroPartido: m.matchNum,
          roundLabel: m.roundLabel,
          status: "pending",
          team1Id: null,
          team1Name: null,
          team2Id: null,
          team2Name: null,
          cruce: m.cruce,
          cancha: m.cancha,
          fecha: m.fecha,
          hora: m.hora,
          slot1SourceFrom: m.slot1SourceFrom,
          slot1SourceResult: m.slot1SourceResult,
          slot2SourceFrom: m.slot2SourceFrom,
          slot2SourceResult: m.slot2SourceResult,
          setsData: [],
          zona: null
        };

        const defaultRoundLabel = getMainDrawConfig(rama)[m.matchNum]?.roundLabel;
        if (m.roundLabel && defaultRoundLabel && m.roundLabel !== defaultRoundLabel) {
          baseData.roundLabelCSV = m.roundLabel;
        }

        batch.set(docRef, baseData);
        totalRows++;
      });

      await batch.commit();

      mainDrawStatus.textContent =
        `✅ Partidos del cuadro creados para ${rama === "F" ? "Femenino" : "Masculino"}.\n` +
        `Filas importadas: ${totalRows}.\n` +
        `Ya podés revisarlos en /bracket y asignar equipos de 1ra ronda.`;

    } catch (err) {
      console.error(err);
      mainDrawStatus.textContent = "❌ Error al importar el cuadro. Revisá la consola para más detalles.";
    }
  }

  /* ============================
   * 4) EXPORTAR PARTIDOS A CSV
   * ============================ */

  async function exportMainDrawToCSV(rama) {
    try {
      mainDrawStatus.textContent = "Exportando partidos del cuadro…";

      const q = query(
        collection(db, "matches"),
        where("phase", "==", "maindraw"),
        where("rama", "==", rama)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        mainDrawStatus.textContent =
          `No hay partidos cargados del cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.`;
        return;
      }

      const rows = [
        ["numeroPartido", "ronda", "cruce", "fecha", "hora", "cancha"]
      ];

      const items = snap.docs
        .map(d => d.data())
        .sort((a, b) => (a.numeroPartido || 0) - (b.numeroPartido || 0));

      items.forEach(m => {
        rows.push([
          m.numeroPartido || "",
          m.roundLabel || "",
          m.cruce || "",
          m.fecha || "",
          m.hora || "",
          m.cancha || ""
        ]);
      });

      const csvContent = rows
        .map(r => r.map(v => String(v)).join(";"))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `maindraw_${rama}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      mainDrawStatus.textContent = "✔ Exportación lista.";

    } catch (error) {
      console.error(error);
      mainDrawStatus.textContent = "❌ Error exportando el cuadro.";
    }
  }

  /* ============================
   * 5) LEER RANKING GENERAL
   * ============================ */

/* ============================
 * 5) RANKING DIRECTO DESDE PARTIDOS (como tabla general)
 * ============================ */

async function fetchRankingForRama(rama) {
  // Leemos TODOS los partidos
  const snap = await getDocs(collection(db, "matches"));
  const matches = [];

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const categoria = (d.categoria || d.category || d.rama || "").toString().toUpperCase().charAt(0);
    const zona      = (d.zona || d.zone || "").toString().trim().toUpperCase();
    const phase     = d.phase || d.fase || null;

    // Solo partidos de esta rama y que NO sean del cuadro principal
    if(categoria !== rama) return;
    if(phase === "maindraw") return;

    matches.push({
      localName: d.localName || "",
      visitanteName: d.visitanteName || "",
      categoria,
      zona,
      estado: d.estado || "Pendiente",
      setsData: d.setsData || []
    });
  });

  if(matches.length === 0) {
    return [];
  }

  // Helpers internos
  function calcCoef(t){
    if (t.ptsLost === 0){
      return t.ptsWon > 0 ? t.ptsWon : 0;
    }
    return t.ptsWon / t.ptsLost;
  }

  function compareTeams(a,b){
    if(b.tablePts !== a.tablePts) return b.tablePts - a.tablePts;

    const diffA = a.ptsWon - a.ptsLost;
    const diffB = b.ptsWon - b.ptsLost;
    if(diffB !== diffA) return diffB - diffA;

    const coefA = calcCoef(a);
    const coefB = calcCoef(b);
    if(coefB !== coefA) return coefB - coefA;

    return (a.teamName || "").localeCompare(b.teamName || "");
  }

  function computeStandingsByZone(){
    const map = new Map();

    // Inicializar equipos
    matches.forEach(m => {
      const zona = m.zona || "SIN ZONA";

      const equipos = [
        { name: m.localName },
        { name: m.visitanteName }
      ];

      equipos.forEach(e => {
        if(!e.name) return;
        const key = `${e.name}|${rama}|${zona}`;
        if(!map.has(key)){
          map.set(key, {
            teamName: e.name,
            categoria: rama,
            zona: zona,
            played: 0,
            wins: 0,
            losses: 0,
            ptsWon: 0,
            ptsLost: 0,
            tablePts: 0
          });
        }
      });
    });

    const PTS_WIN  = 2;
    const PTS_LOSS = 1;

    // Sumamos stats solo de finalizados
    matches.forEach(m => {
      if(m.estado !== "Finalizado") return;

      const zona = m.zona || "SIN ZONA";
      const { localName, visitanteName } = m;
      if(!localName || !visitanteName) return;

      let ptsLocal = 0;
      let ptsVisit = 0;
      if(Array.isArray(m.setsData)){
        m.setsData.forEach(s => {
          ptsLocal += s.puntosLocal ?? 0;
          ptsVisit += s.puntosVisitante ?? 0;
        });
      }
      if(ptsLocal === 0 && ptsVisit === 0) return;

      const localKey = `${localName}|${rama}|${zona}`;
      const visitKey = `${visitanteName}|${rama}|${zona}`;

      if(!map.has(localKey)){
        map.set(localKey, {
          teamName: localName,
          categoria: rama,
          zona,
          played: 0,wins:0,losses:0,ptsWon:0,ptsLost:0,tablePts:0
        });
      }
      if(!map.has(visitKey)){
        map.set(visitKey, {
          teamName: visitanteName,
          categoria: rama,
          zona,
          played: 0,wins:0,losses:0,ptsWon:0,ptsLost:0,tablePts:0
        });
      }

      const localStat = map.get(localKey);
      const visitStat = map.get(visitKey);

      localStat.played++;
      visitStat.played++;

      localStat.ptsWon  += ptsLocal;
      localStat.ptsLost += ptsVisit;
      visitStat.ptsWon  += ptsVisit;
      visitStat.ptsLost += ptsLocal;

      if(ptsLocal > ptsVisit){
        localStat.wins++;
        visitStat.losses++;
        localStat.tablePts += PTS_WIN;
        visitStat.tablePts += PTS_LOSS;
      } else {
        visitStat.wins++;
        localStat.losses++;
        visitStat.tablePts += PTS_WIN;
        localStat.tablePts += PTS_LOSS;
      }
    });

    const zonasMap = {};
    for(const s of map.values()){
      const z = s.zona || "SIN ZONA";
      if(!zonasMap[z]) zonasMap[z] = [];
      zonasMap[z].push(s);
    }

    Object.keys(zonasMap).forEach(z => {
      zonasMap[z].sort(compareTeams);
    });

    return zonasMap;
  }

  function computeGlobalStandings(){
    const zonasMap  = computeStandingsByZone();
    const zoneNames = Object.keys(zonasMap);

    const firsts  = [];
    const seconds = [];
    const thirds  = [];
    const others  = [];

    zoneNames.forEach(z => {
      const lista = zonasMap[z];
      lista.forEach((t, idx) => {
        const enriched = {
          ...t,
          zoneName: z,
          posZona: idx + 1
        };
        if(idx === 0) firsts.push(enriched);
        else if(idx === 1) seconds.push(enriched);
        else if(idx === 2) thirds.push(enriched);
        else others.push(enriched);
      });
    });

    firsts.sort(compareTeams);
    seconds.sort(compareTeams);
    thirds.sort(compareTeams);
    others.sort(compareTeams);

    return [...firsts, ...seconds, ...thirds, ...others];
  }

  const globalList = computeGlobalStandings();

  // Adaptamos al formato que usa assignTeamsFromRanking
  return globalList.map((t, idx) => ({
    teamId: t.teamId || null,
    teamName: t.teamName || "",
    position: idx + 1
  }));
}



  /* ============================
   * 6) ASIGNAR EQUIPOS EN 1RA RONDA
   * ============================ */

async function assignTeamsFromRanking(rama) {
  try {
    mainDrawStatus.textContent = "Verificando que existan partidos de cuadro...";

    const q = query(
      collection(db, "matches"),
      where("phase", "==", "maindraw"),
      where("rama", "==", rama)
    );
    const snap = await getDocs(q);

    if (snap.empty) {
      mainDrawStatus.textContent =
        `❌ No hay partidos de cuadro para ${rama === "F" ? "Femenino" : "Masculino"}.\nPrimero importá el cuadro con el CSV.`;
      return;
    }

    const matches = [];
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const num = data.drawMatchNumber || data.numeroPartido;
      if (!num) return;
      matches.push({ ref: docSnap.ref, data, matchNum: num });
    });

    const firstRoundLimit = rama === "F" ? 8 : 16;
    const firstRoundMatches = matches.filter(m =>
      (m.data.slot1SourceFrom ?? null) === null &&
      (m.data.slot2SourceFrom ?? null) === null &&
      m.matchNum <= firstRoundLimit
    );

    if (firstRoundMatches.length === 0) {
      mainDrawStatus.textContent =
        "❌ No se detectaron partidos de 1ra ronda con slots libres para asignar equipos.";
      return;
    }

    mainDrawStatus.textContent = "Calculando ranking...";

    const ranking = await fetchRankingForRama(rama);

    if (!ranking || ranking.length === 0) {
      mainDrawStatus.textContent =
        `❌ El ranking de ${rama === "F" ? "Femenino" : "Masculino"} no tiene equipos cargados.`;
      return;
    }

    const seedsNeeded = rama === "F" ? 16 : 32;
    const maxSeeds = Math.min(ranking.length, seedsNeeded);
    const seedByNumber = {};

    for (let idx = 0; idx < maxSeeds; idx++) {
      const seedNum = idx + 1;
      const item = ranking[idx];
      seedByNumber[seedNum] = {
        teamId: item.teamId || null,
        teamName: item.teamName || `Seed ${seedNum}`
      };
    }

    const seedMap = getFirstRoundSeedMap(rama) || [];
    mainDrawStatus.textContent =
      `Asignando equipos de la 1ra ronda según el ranking (${maxSeeds} equipos disponibles)...`;

    const batch = writeBatch(db);
    let partidosActualizados = 0;

    // Procesar siempre en orden numérico para que el cruce se mantenga estable
    firstRoundMatches
      .slice()
      .sort((a, b) => Number(a.matchNum) - Number(b.matchNum))
      .forEach(match => {
      const parsedCruce = parseSeedsFromCruce(match.data.cruce);
      const predefined = Array.isArray(seedMap)
        ? seedMap.find(m => Number(m.match) === Number(match.matchNum))
        : null;

      const seedNums = parsedCruce
        ? [parsedCruce.seed1, parsedCruce.seed2]
        : predefined
          ? [predefined.seed1, predefined.seed2]
          : [null, null];

      const s1 = seedNums[0] ? seedByNumber[seedNums[0]] : null;
      const s2 = seedNums[1] ? seedByNumber[seedNums[1]] : null;

      if (!s1 && !s2) return;

      const updateData = {};

      if (s1) {
        updateData.team1Id = s1.teamId;
        updateData.team1Name = s1.teamName;
      } else {
        updateData.team1Id = null;
        updateData.team1Name = null;
      }

      if (s2) {
        updateData.team2Id = s2.teamId;
        updateData.team2Name = s2.teamName;
      } else {
        updateData.team2Id = null;
        updateData.team2Name = null;
      }

      updateData.status = "pending";

      batch.update(match.ref, updateData);
      partidosActualizados++;
    });

    await batch.commit();

    mainDrawStatus.textContent =
      `✅ Equipos asignados en la 1ra ronda para ${rama === "F" ? "Femenino" : "Masculino"}.\n` +
      `Ranking disponible: ${ranking.length} equipos, usados: ${maxSeeds}.\n` +
      `Partidos de 1ra ronda actualizados: ${partidosActualizados}.`;

  } catch (err) {
    console.error(err);
    mainDrawStatus.textContent =
      "❌ Error al asignar equipos desde el ranking. Revisá la consola para más detalles.";
  }
}

</script>

</body>
</html>
