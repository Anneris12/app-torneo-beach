<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Fixture</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: #031926;
  color: white;
  font-family: system-ui, sans-serif;
  padding: 20px;
}

.top-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.top-btn {
  background: #ffe36a;
  color: #000;
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 10px;
  text-decoration: none;
  border: none;
  font-size: 14px;
}

h1 {
  text-align: center;
  margin: 0 0 10px;
}

/* Botones de rama */
.rama-switch {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
}

.rama-btn {
  background: #ffe36a;
  color: #000;
  font-weight: 600;
  padding: 6px 14px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 13px;
}

.rama-btn.active {
  background: #7cffc1;
}

/* Ocultamos el combo de rama original */
#filterCat {
  display: none;
}

/* Filtros */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

.filters select,
.filters input {
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(3,25,38,0.8);
  color: white;
  font-size: 13px;
}

.filters input {
  flex: 1 1 150px;
}

/* Tabla */
.fixture-wrapper {
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
  overflow: auto;
  max-height: 75vh;
}

.fixture-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.fixture-table th,
.fixture-table td {
  padding: 4px 6px;
  white-space: nowrap;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

.fixture-table th {
  background: #02131f;
  position: sticky;
  top: 0;
  z-index: 1;
}

/* columnas */
.col-num {
  width: 40px;
  text-align: center;
}
.col-cat {
  width: 40px;
  text-align: center;
}
.col-zona {
  width: 50px;
  text-align: center;
}
.col-cancha {
  width: 50px;
  text-align: center;
}
.col-hora {
  width: 60px;
  text-align: center;
}
.col-fecha {
  width: 90px;
}
.col-eq1 {
  min-width: 150px;
}
.col-res {
  min-width: 80px;
}
.col-estado {
  width: 90px;
  text-align: center;
}

/* Eq2 debajo */
.eq2 {
  display: block;
  font-size: 12px;
  color: #d0d8e0;
}

/* Estado */
.estado-pill {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
}

.estado-finalizado {
  background: #7cffc1;
  color: #000;
}
.estado-enjuego {
  background: #ffe36a;
  color: #000;
}
.estado-pendiente {
  background: #aaaaaa;
  color: #000;
}

/* Resultado por sets */
.res-team-line {
  display: flex;
  align-items: center;
  gap: 4px;
  line-height: 1.1;
  margin-bottom: 2px;
}

.set-num {
  display: inline-block;
  min-width: 18px;
  text-align: center;
  font-size: 11px;
}

.set-num.ganador {
  color: #7cffc1;
  font-weight: 700;
}

/* Ordenable */
th.sortable {
  cursor: pointer;
  user-select: none;
}

th.sort-asc::after {
  content: " ▲";
  font-size: 10px;
}

th.sort-desc::after {
  content: " ▼";
  font-size: 10px;
}

/* Celular */
@media (max-width:480px){
  .fixture-table { font-size: 12px; }
  .fixture-table th { font-size: 11px; }
}
</style>
</head>
<body>

<div class="top-buttons">
  <a class="top-btn" href="index.html">Inicio</a>
  <a class="top-btn" href="positions.html">Tabla de posiciones</a>
</div>

<h1>FIXTURE</h1>

<!-- Botones Femenino / Masculino -->
<div class="rama-switch">
  <button id="btnRamaF" class="rama-btn active">Femenino</button>
  <button id="btnRamaM" class="rama-btn">Masculino</button>
</div>

<!-- FILTROS -->
<div class="filters">
  <select id="filterCat">
    <option value="all">Rama: Todas</option>
    <option value="F">Femenino</option>
    <option value="M">Masculino</option>
  </select>

  <select id="filterZone"></select>

  <select id="filterCourt"></select>

  <select id="filterStatus">
    <option value="all">Estado: Todos</option>
    <option value="Pendiente">Pendiente</option>
    <option value="En juego">En juego</option>
    <option value="Finalizado">Finalizado</option>
  </select>

  <input id="filterSearch" type="text" placeholder="Buscar equipo..." />
</div>

<!-- TABLA -->
<div class="fixture-wrapper">
  <table class="fixture-table">
    <thead>
      <tr>
        <th class="col-num sortable"   data-field="numeroPartido">#</th>
        <th class="col-cat sortable"   data-field="categoria">F/M</th>
        <th class="col-zona sortable"  data-field="zona">Z</th>
        <th class="col-cancha sortable" data-field="cancha">C</th>
        <th class="col-hora sortable"  data-field="hora">Hora</th>
        <th class="col-fecha sortable" data-field="fecha">Fecha</th>
        <th class="col-eq1 sortable"   data-field="localName">Eq1 / Eq2</th>
        <th class="col-res">Resultado</th>
        <th class="col-estado sortable" data-field="estado">Estado</th>
      </tr>
    </thead>
    <tbody id="fixtureBody"></tbody>
  </table>
</div>


<!-- FIREBASE + SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDLMrgeu3pNs-hOM1vf006wMzWPqfQ_lQ",
  authDomain: "torneo-beach.firebaseapp.com",
  projectId: "torneo-beach",
  storageBucket: "torneo-beach.firebasestorage.app",
  messagingSenderId: "21136645638",
  appId: "1:21136645638:web:52c3b06affc2ee151eed87"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* DOM */
const btnRamaF     = document.getElementById("btnRamaF");
const btnRamaM     = document.getElementById("btnRamaM");
const filterCat    = document.getElementById("filterCat");
const filterZone   = document.getElementById("filterZone");
const filterCourt  = document.getElementById("filterCourt");
const filterStatus = document.getElementById("filterStatus");
const filterSearch = document.getElementById("filterSearch");
const fixtureBody  = document.getElementById("fixtureBody");
const sortableHeaders = document.querySelectorAll(".fixture-table th.sortable");

let allMatches = [];
let zonas = new Set();
let canchas = new Set();

let sortField = "fecha";
let sortDir   = "asc";

/* ---------------- Normalizadores ---------------- */

function normalizeCategoria(c){
  if(!c) return "";
  const up = c.toString().toUpperCase();
  if(up.startsWith("F")) return "F";
  if(up.startsWith("M")) return "M";
  return up;
}

function normalizeZona(z){
  return (z||"").toString().trim().toUpperCase();
}

function normalizeHora(hora){
  if(!hora) return "";
  let clean = hora.toString().trim();
  if(clean.includes(":")) return clean;
  clean = clean.replace(/\D/g,"");
  if(clean.length===3) clean="0"+clean;
  if(clean.length!==4) return hora;
  return clean.slice(0,2)+":"+clean.slice(2);
}

function formatFecha(fechaStr){
  if(!fechaStr) return "";
  if(fechaStr.includes("/")) return fechaStr;
  const parts=fechaStr.split("-");
  if(parts.length!==3) return fechaStr;
  const [y,m,d]=parts;
  return `${d}/${m}/${y}`;
}

/* Resultado HTML */
function buildResultadoHTML(match){
  if(match.estado!=="Finalizado" || !match.setsData || match.setsData.length===0)
    return "—";

  const sets  = match.setsData;
  const localNums=[];
  const visitNums[];

  sets.forEach(s=>{
    const pl=s.puntosLocal??0;
    const pv=s.puntosVisitante??0;

    const lcls = pl>pv ? "ganador":"";
    const vcls = pv>pl ? "ganador":"";

    localNums.push(`<span class="set-num ${lcls}">${pl}</span>`);
    visitNums.push(`<span class="set-num ${vcls}">${pv}</span>`);
  });

  return `
    <div class="res-team-line">
      ${localNums.join("")}
    </div>
    <div class="res-team-line">
      ${visitNums.join("")}
    </div>
  `;
}

/* Estado visual */
function estClass(e){
  if(e==="Finalizado") return "estado-finalizado";
  if(e==="En juego") return "estado-enjuego";
  return "estado-pendiente";
}

/* Botones rama */
function updateRamaButtons(){
  const val = filterCat.value;
  btnRamaF.classList.toggle("active", val==="F");
  btnRamaM.classList.toggle("active", val==="M");
}

/* Filtros dinámicos */
function renderFilterOptions(){
  filterZone.innerHTML = `<option value="all">Zona: Todas</option>`;
  [...zonas].sort().forEach(z=>{
    filterZone.innerHTML += `<option value="${z}">Zona ${z}</option>`;
  });

  filterCourt.innerHTML = `<option value="all">Cancha: Todas</option>`;
  [...canchas].sort((a,b)=> Number(a)-Number(b))
    .forEach(c=>{
      filterCourt.innerHTML += `<option value="${c}">Cancha ${c}</option>`;
    });
}

/* Orden headers */
function updateHeaderSortClasses(){
  sortableHeaders.forEach(th=>{
    th.classList.remove("sort-asc","sort-desc");
    if(th.dataset.field === sortField){
      th.classList.add(sortDir==="asc" ? "sort-asc" : "sort-desc");
    }
  });
}

/* Render tabla */
function renderTable(){
  let list=[...allMatches];

  // Rama F/M (nunca mostramos todas)
  if(filterCat.value!=="all"){
    list=list.filter(m=>m.categoria===filterCat.value);
  }

  if(filterZone.value!=="all")
    list=list.filter(m=>m.zona===filterZone.value);

  if(filterCourt.value!=="all")
    list=list.filter(m=>String(m.cancha)===filterCourt.value);

  if(filterStatus.value!=="all")
    list=list.filter(m=>m.estado===filterStatus.value);

  const search = filterSearch.value.trim().toLowerCase();
  if (search) {
    list = list.filter(m => {
      const l = (m.localName || "").toLowerCase();
      const v = (m.visitanteName || "").toLowerCase();
      return l.includes(search) || v.includes(search);
    });
  }

  // Orden
  list.sort((a,b)=>{
    let valA = a[sortField];
    let valB = b[sortField];

    if(valA==null) valA="";
    if(valB==null) valB="";

    if(sortField==="numeroPartido"){
      const nA = Number(valA) || 0;
      const nB = Number(valB) || 0;
      return sortDir==="asc" ? nA-nB : nB-nA;
    }

    if(sortField==="fecha"){
      const fA = a.fecha || "";
      const fB = b.fecha || "";
      if(fA===fB) return 0;
      if(sortDir==="asc") return fA>fB ? 1 : -1;
      return fA<fB ? 1 : -1;
    }

    if(sortField==="hora"){
      const hA = normalizeHora(a.hora||"");
      const hB = normalizeHora(b.hora||"");
      if(hA===hB) return 0;
      if(sortDir==="asc") return hA>hB ? 1 : -1;
      return hA<hB ? 1 : -1;
    }

    const sA = valA.toString().toLowerCase();
    const sB = valB.toString().toLowerCase();
    if(sA===sB) return 0;
    if(sortDir==="asc") return sA>sB ? 1 : -1;
    return sA<sB ? 1 : -1;
  });

  if(list.length===0){
    fixtureBody.innerHTML =
      `<tr><td colspan="9">No hay partidos con estos filtros.</td></tr>`;
    updateHeaderSortClasses();
    return;
  }

  fixtureBody.innerHTML="";

  list.forEach(m=>{
    const tr=document.createElement("tr");

    const horaFmt  = normalizeHora(m.hora);
    const fechaFmt = formatFecha(m.fecha);
    const estCls   = estClass(m.estado || "Pendiente");

    tr.innerHTML = `
      <td class="col-num">${m.numeroPartido||""}</td>
      <td class="col-cat">${m.categoria||""}</td>
      <td class="col-zona">${m.zona||""}</td>
      <td class="col-cancha">${m.cancha||""}</td>
      <td class="col-hora">${horaFmt}</td>
      <td class="col-fecha">${fechaFmt}</td>

      <td class="col-eq1">
        ${m.localName||""}
        <span class="eq2">${m.visitanteName||""}</span>
      </td>

      <td class="col-res">
        ${buildResultadoHTML(m)}
      </td>

      <td class="col-estado">
        <span class="estado-pill ${estCls}">
          ${m.estado||"Pendiente"}
        </span>
      </td>
    `;

    fixtureBody.appendChild(tr);
  });

  updateHeaderSortClasses();
}

/* Escuchar cambios en matches */
onSnapshot(collection(db,"matches"), snap=>{
  allMatches=[];
  zonas.clear();
  canchas.clear();

  snap.forEach(docSnap=>{
    const d = docSnap.data();

    // Solo fase de zonas
    const phase = d.phase || "zonas";
    if (phase !== "zonas") return;

    const categoria = normalizeCategoria(d.categoria || d.category);
    const zona      = normalizeZona(d.zona || d.zone);
    const cancha    = d.cancha || "";
    const estado    = d.estado || "Pendiente";

    allMatches.push({
      id: docSnap.id,
      numeroPartido: d.numeroPartido,
      categoria,
      zona,
      cancha,
      hora: d.hora || "",
      fecha: d.fecha || "",
      localName: d.localName || "",
      visitanteName: d.visitanteName || "",
      estado,
      setsData: d.setsData || []
    });

    if(zona) zonas.add(zona);
    if(cancha) canchas.add(String(cancha));
  });

  renderFilterOptions();
  renderTable();
});

/* Eventos filtros */
filterCat.onchange    = ()=>{ updateRamaButtons(); renderTable(); };
filterZone.onchange   = renderTable;
filterCourt.onchange  = renderTable;
filterStatus.onchange = renderTable;
filterSearch.addEventListener("input", renderTable);

/* Eventos botones rama */
btnRamaF.addEventListener("click", ()=>{
  filterCat.value="F";
  updateRamaButtons();
  renderTable();
});
btnRamaM.addEventListener("click", ()=>{
  filterCat.value="M";
  updateRamaButtons();
  renderTable();
});

/* Eventos orden encabezados */
sortableHeaders.forEach(th=>{
  th.addEventListener("click", ()=>{
    const field = th.dataset.field;
    if(!field) return;
    if(sortField===field){
      sortDir = (sortDir==="asc") ? "desc" : "asc";
    } else {
      sortField = field;
      sortDir = "asc";
    }
    renderTable();
  });
});

/* Estado inicial rama */
filterCat.value = "F";
updateRamaButtons();
</script>

</body>
</html>
